# PHASE 5: Админка «Администраторы»

> **Детальная постановка задач для Фазы 5**  
> UI для управления администраторами сервиса (service admins)

**Версия:** 1.0  
**Дата:** 2026-02-06  
**Ориентировочный срок:** 3–5 дней  
**Предусловие:** Для единой навигации желательно завершение Фазы 4 (пункт меню «Администраторы» добавляется там). API уже есть в v1.0 — при необходимости Фазу 5 можно выполнять параллельно с 4/6 и добавить пункт меню в рамках этой фазы.

---

## Связанные документы

| Документ | Описание | Статус |
|----------|----------|--------|
| [ARCHITECTURE_BLUEPRINT.md](ARCHITECTURE_BLUEPRINT.md) | Целевая архитектура системы | ✅ Актуален (не завершено) |
| [UPGRADE_TASKS.md](UPGRADE_TASKS.md) | Декомпозиция всех задач | ✅ Актуален (не завершено) |
| [PLAN_PHASE_0_1.md](PLAN_PHASE_0_1.md) | Детальный план Фазы 0-1 | ✅ Актуален (не завершено) |
| [PLAN_PHASE_2.md](PLAN_PHASE_2.md) | Детальный план Фазы 2 | ✅ Актуален (не завершено) |
| [PLAN_PHASE_3.md](PLAN_PHASE_3.md) | Детальный план Фазы 3 | ✅ Актуален (не завершено) |
| [PLAN_PHASE_4.md](PLAN_PHASE_4.md) | Детальный план Фазы 4 | ✅ Актуален (не завершено) |
| [PLAN_PHASE_5.md](PLAN_PHASE_5.md) | Детальный план Фазы 5 (этот документ) | ✅ Актуален (не завершено) |
| [PLAN_PHASE_6.md](PLAN_PHASE_6.md) | Детальный план Фазы 6 (следующая) | ✅ Актуален (не завершено) |

---

## Навигация по фазам

| Фаза | Документ | Описание | Статус |
|------|----------|----------|--------|
| 0-1 | [PLAN_PHASE_0_1.md](PLAN_PHASE_0_1.md) | Стабилизация + Tool-Calling | ✅ Актуален (не завершено) |
| 2 | [PLAN_PHASE_2.md](PLAN_PHASE_2.md) | Plugin System | ✅ Актуален (не завершено) |
| 3 | [PLAN_PHASE_3.md](PLAN_PHASE_3.md) | Storage + API | ✅ Актуален (не завершено) |
| 4 | [PLAN_PHASE_4.md](PLAN_PHASE_4.md) | Админка Инструменты | ✅ Актуален (не завершено) |
| 5 | **[PLAN_PHASE_5.md](PLAN_PHASE_5.md)** | Админка Администраторы | ✅ Актуален (не завершено) |
| 6 | [PLAN_PHASE_6.md](PLAN_PHASE_6.md) | Worklog Checker | ✅ Актуален (не завершено) |

### Текущая реализация (v1.0)

| Документ | Описание |
|----------|----------|
| [TG_Project_Helper_v1.0.md](TG_Project_Helper_v1.0.md) | Спецификация (API `/api/service-admins/*` уже реализован) |
| [TG_Project_Helper_v1.0_QUICKSTART.md](TG_Project_Helper_v1.0_QUICKSTART.md) | Быстрый старт и FAQ |

---

## Общая цель Фазы 5

**Было:** API для управления администраторами сервиса уже реализован (`/api/service-admins/*`), но управлять списком можно только через Swagger или curl.

**Стало:** В админке появляется полноценный раздел «Администраторы» с UI: просмотр списка, добавление по Telegram ID, обновление профиля из Telegram, удаление с подтверждением.

**Важно:**

- Используется существующий стек (vanilla JS, fetch API).
- Стилистика консистентна с разделами «Настройки» и «Инструменты».
- Бэкенд **не меняется** — все эндпоинты уже есть.

---

## Существующий API (референс)

Все эндпоинты защищены заголовком `X-Admin-Key` (если задан `ADMIN_API_KEY`).

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/api/service-admins` | Список администраторов. Ответ: `{ admins: ServiceAdminResponse[], total: number }` |
| POST | `/api/service-admins` | Добавить администратора. Body: `{ telegram_id: number }`. Ответ: `ServiceAdminResponse`. 409 если уже есть. |
| GET | `/api/service-admins/{telegram_id}` | Один администратор по Telegram ID. 404 если не найден. |
| DELETE | `/api/service-admins/{telegram_id}` | Удалить администратора. 204 при успехе, 404 если не найден. |
| POST | `/api/service-admins/{telegram_id}/refresh` | Обновить профиль из Telegram. Ответ: `ServiceAdminResponse`. 404 если не найден. |

### Модель ServiceAdminResponse

| Поле | Тип | Описание |
|------|-----|----------|
| id | number | Внутренний ID записи |
| telegram_id | number | Telegram user ID |
| first_name | string \| null | Имя из профиля Telegram |
| last_name | string \| null | Фамилия из профиля Telegram |
| username | string \| null | @username из Telegram |
| display_name | string | Отображаемое имя (first_name + last_name или username или "ID: {telegram_id}") |
| is_active | boolean | Активен ли администратор |
| created_at | string (ISO 8601) | Дата добавления |

---

## Дизайн-требования

### Необходимые макеты (опционально)

| # | Экран | Описание | Приоритет |
|---|-------|----------|-----------|
| 1 | Список администраторов | Таблица + кнопка «Добавить» | Средний |
| 2 | Модалка добавления | Поле Telegram ID + подсказка | Средний |
| 3 | Модалка подтверждения удаления | Текст + кнопки Удалить / Отмена | Низкий |

При отсутствии макетов — ориентироваться на существующие разделы админки (таблицы, модалки, кнопки).

---

## Архитектура UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Admin Panel                                                                │
│                                                                             │
│  ┌─────────────┐  ┌───────────────────────────────────────────────────────┐ │
│  │  Навигация  │  │  #admins → Администраторы          [ФАЗА 5]          │ │
│  │             │  │                                                       │ │
│  │  Настройки  │  │  • Заголовок "Администраторы"                        │ │
│  │  Инструменты│  │  • Кнопка "+ Добавить"                              │ │
│  │  Администр. │  │  • Таблица: ID, Имя, Username, Дата добавления       │ │
│  │   (активен) │  │  • Действия: Обновить профиль, Удалить               │ │
│  │             │  │  • Пустое состояние: "Нет администраторов"           │ │
│  └─────────────┘  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Файловая структура

```
admin/
├── index.html          # [РАСШИРЕНИЕ] Контейнер раздела #admins (если ещё не добавлен)
├── styles.css          # [РАСШИРЕНИЕ] Стили для раздела Администраторы
├── app.js              # [РАСШИРЕНИЕ] Роутинг #admins → показ раздела
└── admins.js           # [НОВЫЙ] Логика раздела «Администраторы»
```

Если в Фазе 4 раздел «Администраторы» реализован как заглушка (пустой контейнер), в Фазе 5 в этот контейнер подключается содержимое из `admins.js`.

---

# UI-спецификации

---

## Экран 1: Список администраторов

### Wireframe

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  Администраторы                                    [+ Добавить]             │
│                                                                             │
│  Администраторы сервиса имеют доступ к админ-панели (при вводе Admin key).  │
│  Добавляются по Telegram ID.                                                │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Telegram ID   │  Имя / Display name   │  Username   │  Добавлен    │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  365491351     │  Владимир Ленский      │  @vlensky   │  05.02.2026  │  │
│  │                │                        │             │  [Обновить]  │  │
│  │                │                        │             │  [Удалить]  │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  123456789     │  ID: 123456789         │  —          │  01.02.2026  │  │
│  │                │  (профиль не получен)  │             │  [Обновить]  │  │
│  │                │                        │             │  [Удалить]  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  Всего: 2                                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Пустое состояние

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Администраторы                                    [+ Добавить]             │
│                                                                             │
│  Нет администраторов. Нажмите «Добавить», чтобы добавить первого.          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Поведение

- При открытии раздела (#admins) вызывается `GET /api/service-admins`.
- Данные отображаются в таблице.
- Колонки: Telegram ID, Имя (display_name), Username (или «—»), Дата добавления (форматированная), Действия.
- В строке действий: кнопка «Обновить» (refresh), кнопка «Удалить» (danger).
- Если список пуст — показывается текст пустого состояния.

---

## Экран 2: Модалка «Добавить администратора»

### Wireframe

```
┌─────────────────────────────────────────────────────────┐
│  Добавить администратора                           [×]  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Telegram ID *                                          │
│  ┌─────────────────────────────────────────────────────┐│
│  │ 365491351                                            ││
│  └─────────────────────────────────────────────────────┘│
│  Узнать свой ID: напишите боту @userinfobot в Telegram  │
│                                                         │
│                              [Отмена]  [Добавить]       │
└─────────────────────────────────────────────────────────┘
```

### Поведение

- Кнопка «+ Добавить» открывает модалку.
- Поле «Telegram ID» — число, обязательное. Валидация: целое положительное число.
- Под полем — подсказка: «Узнать свой ID: напишите боту @userinfobot в Telegram».
- «Отмена» / крестик / клик по backdrop — закрытие без сохранения.
- «Добавить» — отправка `POST /api/service-admins` с `{ telegram_id: number }`.
  - Успех (201): закрыть модалку, toast «Администратор добавлен», обновить список.
  - 409: toast «Этот пользователь уже является администратором».
  - 400: toast с текстом ошибки (например, неверный telegram_id).
  - Сеть/ошибка: toast «Ошибка при добавлении».

---

## Экран 3: Модалка подтверждения удаления

### Wireframe

```
┌─────────────────────────────────────────────────────────┐
│  Удалить администратора                            [×]  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Вы уверены, что хотите удалить администратора          │
│  Владимир Ленский (@vlensky)?                           │
│                                                         │
│  Он потеряет доступ к админ-панели.                      │
│                                                         │
│                              [Отмена]  [Удалить]         │
└─────────────────────────────────────────────────────────┘
```

### Поведение

- Кнопка «Удалить» в строке таблицы открывает модалку подтверждения.
- В тексте подставляются display_name и username (если есть), иначе «ID: {telegram_id}».
- «Удалить» — `DELETE /api/service-admins/{telegram_id}`.
  - Успех (204): закрыть модалку, toast «Администратор удалён», обновить список.
  - 404: toast «Администратор не найден», закрыть модалку, обновить список.

---

## Действие «Обновить профиль»

- Кнопка «Обновить» в строке — `POST /api/service-admins/{telegram_id}/refresh`.
- Во время запроса кнопку можно показать в состоянии loading (опционально).
- Успех: toast «Профиль обновлён», обновить строку или весь список.
- Ошибка: toast с сообщением об ошибке.

---

# Задачи Фазы 5

---

## Задача 5.1: Контейнер и роутинг

### Описание

Убедиться, что в админке есть контейнер для раздела «Администраторы» и при переходе по #admins отображается этот раздел (остальные скрыты).

### Что сделать

1. В `index.html` — блок с `id="section-admins"` (или аналогичным), изначально скрыт.
2. В `app.js` — при hash `#admins` показывать `section-admins`, скрывать остальные разделы, подсвечивать пункт меню «Администраторы».

### Файлы

- `admin/index.html`
- `admin/app.js`

### Критерий готовности

- [ ] Переход по #admins открывает раздел «Администраторы»
- [ ] Пункт меню «Администраторы» подсвечивается
- [ ] Остальные разделы скрыты

---

## Задача 5.2: API-функции (admins.js)

### Описание

Реализовать в `admins.js` функции для работы с API (с учётом Admin key из конфига админки).

### Что сделать

1. `loadAdmins()` — GET /api/service-admins, возвращает список.
2. `addAdmin(telegramId)` — POST /api/service-admins, body `{ telegram_id }`, возвращает созданного админа или бросает по статусу.
3. `deleteAdmin(telegramId)` — DELETE /api/service-admins/{telegram_id}.
4. `refreshAdmin(telegramId)` — POST /api/service-admins/{telegram_id}/refresh.
5. Использовать общий метод запросов с заголовком X-Admin-Key (как в существующем app.js для настроек).

### Файлы

- `admin/admins.js`

### Критерий готовности

- [ ] Все четыре метода вызывают корректные эндпоинты
- [ ] Заголовок авторизации передаётся
- [ ] Ошибки (4xx, 5xx) обрабатываются и пробрасываются для показа в UI

---

## Задача 5.3: Отображение списка

### Описание

При открытии раздела загружать список администраторов и отображать его в таблице.

### Что сделать

1. При показе раздела #admins вызывать loadAdmins().
2. Отрисовка таблицы: колонки Telegram ID, Имя (display_name), Username, Дата добавления, Действия.
3. Форматирование даты created_at (локальная дата или ISO на выбор).
4. Пустое состояние: если admins.length === 0 — показать текст «Нет администраторов» и подсказку добавить первого.
5. В колонке «Действия» — кнопки «Обновить» и «Удалить» для каждой строки.

### Файлы

- `admin/admins.js`
- `admin/index.html` (разметка таблицы, при необходимости)

### Критерий готовности

- [ ] Список загружается и отображается
- [ ] Пустое состояние отображается при отсутствии админов
- [ ] Кнопки «Обновить» и «Удалить» присутствуют в каждой строке

---

## Задача 5.4: Модалка добавления

### Описание

Модальное окно для добавления администратора по Telegram ID.

### Что сделать

1. HTML-разметка модалки: заголовок, поле Telegram ID (number input), подсказка про @userinfobot, кнопки Отмена / Добавить.
2. Открытие по кнопке «+ Добавить», закрытие по крестику, кнопке «Отмена» и клику по backdrop.
3. Валидация: Telegram ID — целое положительное число.
4. Отправка POST при нажатии «Добавить», обработка 201 / 409 / 400 и сетевых ошибок, toast и обновление списка при успехе.

### Файлы

- `admin/index.html` или `admin/admins.js` (разметка модалки может генерироваться из JS)
- `admin/admins.js`
- `admin/styles.css` (стили модалки, если ещё не общие)

### Критерий готовности

- [ ] Модалка открывается и закрывается
- [ ] Валидация срабатывает
- [ ] Успешное добавление закрывает модалку и обновляет список
- [ ] Ошибки 409 и 400 отображаются в toast

---

## Задача 5.5: Модалка подтверждения удаления

### Описание

Модальное окно подтверждения перед удалением администратора.

### Что сделать

1. Разметка: текст «Удалить администратора {display_name} (@username)?» (или «ID: {telegram_id}»), пояснение про потерю доступа, кнопки Отмена / Удалить.
2. При нажатии «Удалить» в таблице открывать модалку, передавая в неё текущую строку (telegram_id, display_name, username).
3. Кнопка «Удалить» в модалке — DELETE запрос, при 204 — закрытие, toast, обновление списка.
4. При 404 — toast и обновление списка.

### Файлы

- `admin/admins.js`
- `admin/index.html` или генерируемая разметка
- `admin/styles.css`

### Критерий готовности

- [ ] Модалка показывает имя/username удаляемого
- [ ] Удаление выполняется и список обновляется
- [ ] Отмена закрывает модалку без запроса

---

## Задача 5.6: Действие «Обновить профиль»

### Описание

Обработчик кнопки «Обновить» в строке таблицы.

### Что сделать

1. По клику вызывать refreshAdmin(telegram_id).
2. При успехе — toast «Профиль обновлён», обновить данные в строке или перезагрузить список.
3. При ошибке — toast с сообщением.

### Файлы

- `admin/admins.js`

### Критерий готовности

- [ ] Запрос отправляется
- [ ] При успехе список/строка обновляются
- [ ] Ошибки отображаются в toast

---

## Задача 5.7: Стили

### Описание

Стили для раздела «Администраторы»: таблица, кнопки, модалки, пустое состояние. Консистентность с разделами «Настройки» и «Инструменты».

### Файлы

- `admin/styles.css`

### Критерий готовности

- [ ] Таблица читаема и выровнена
- [ ] Кнопки и модалки выглядят в едином стиле с остальной админкой
- [ ] Адаптивность (на малых экранах таблица не ломается или заменяется на карточки — по согласованию)

---

## Задача 5.8: Тестирование

### Ручное тестирование (чеклист)

#### Список

- [ ] При открытии #admins список загружается
- [ ] Пустое состояние отображается при отсутствии записей
- [ ] Отображение Telegram ID, имени, username, даты

#### Добавление

- [ ] Модалка открывается по «+ Добавить»
- [ ] Валидация отрицательного/нулевого ID
- [ ] Успешное добавление (201) — модалка закрывается, список обновляется
- [ ] Повторное добавление того же ID — 409, toast
- [ ] Несуществующий/некорректный ID — обработка 400

#### Обновление профиля

- [ ] Кнопка «Обновить» отправляет запрос
- [ ] После успеха данные в списке обновляются

#### Удаление

- [ ] Модалка подтверждения открывается с корректным именем
- [ ] Отмена не выполняет удаление
- [ ] Подтверждение выполняет DELETE и обновляет список

### Критерий готовности

- [ ] Все пункты чеклиста пройдены
- [ ] В консоли нет ошибок

---

## Последовательность работ

```
ДЕНЬ 1: Каркас и список
├── 5.1 Контейнер и роутинг
├── 5.2 API-функции
└── 5.3 Отображение списка

ДЕНЬ 2: Добавление и удаление
├── 5.4 Модалка добавления
└── 5.5 Модалка подтверждения удаления

ДЕНЬ 3: Доработка и тестирование
├── 5.6 Действие «Обновить профиль»
├── 5.7 Стили
└── 5.8 Тестирование
```

---

## Definition of Done для Фазы 5

- [ ] Все задачи 5.1–5.8 выполнены
- [ ] Раздел «Администраторы» открывается по #admins
- [ ] Список администраторов загружается и отображается
- [ ] Добавление по Telegram ID работает (включая валидацию и обработку 409)
- [ ] Удаление с подтверждением работает
- [ ] Обновление профиля из Telegram работает
- [ ] Ручное тестирование пройдено
- [ ] В консоли нет ошибок

---

## Что НЕ входит в Фазу 5

- Изменение API бэкенда (все эндпоинты уже реализованы)
- Роли и права внутри списка администраторов (все с одинаковыми правами)
- Unit-тесты для JS
- Бизнес-плагины (Фаза 6)

---

## Версионирование документа

| Версия | Дата | Описание |
|--------|------|----------|
| 1.0 | 2026-02-06 | Первая версия плана Фазы 5 |
