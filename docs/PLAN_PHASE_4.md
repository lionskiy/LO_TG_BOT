# PHASE 4: Admin "Tools"

> **Детальная постановка задач для Фазы 4**  
> UI для управления инструментами и их настройками

**Версия:** 1.0  
**Дата:** 2026-02-06  
**Ориентировочный срок:** 5-7 дней  
**Предусловие:** Фаза 3 завершена (API для инструментов работает)

---

## Связанные документы

| Документ | Описание | Статус |
|----------|----------|--------|
| [ARCHITECTURE_BLUEPRINT.md](ARCHITECTURE_BLUEPRINT.md) | Целевая архитектура системы | ✅ Current (in progress) |
| [UPGRADE_TASKS.md](UPGRADE_TASKS.md) | Декомпозиция всех задач | ✅ Current (in progress) |
| [PLAN_PHASE_0_1.md](PLAN_PHASE_0_1.md) | Детальный план Фазы 0-1 | ✅ Current (in progress) |
| [PLAN_PHASE_2.md](PLAN_PHASE_2.md) | Детальный план Фазы 2 | ✅ Current (in progress) |
| [PLAN_PHASE_3.md](PLAN_PHASE_3.md) | Детальный план Фазы 3 | ✅ Current (in progress) |
| [PLAN_PHASE_4.md](PLAN_PHASE_4.md) | Детальный план Фазы 4 (этот документ) | ✅ Current (in progress) |
| [PLAN_PHASE_5.md](PLAN_PHASE_5.md) | Детальный план Фазы 5 (следующая) | ✅ Current (in progress) |

### Текущая реализация (v1.0)

| Документ | Описание |
|----------|----------|
| [TG_Project_Helper_v1.0.md](TG_Project_Helper_v1.0.md) | Спецификация текущей реализации |
| [TG_Project_Helper_v1.0_QUICKSTART.md](TG_Project_Helper_v1.0_QUICKSTART.md) | Быстрый старт и FAQ |

---

## Навигация по фазам

| Фаза | Документ | Описание | Статус |
|------|----------|----------|--------|
| 0-1 | [PLAN_PHASE_0_1.md](PLAN_PHASE_0_1.md) | Stabilization + Tool-Calling | ✅ Current (in progress) |
| 2 | [PLAN_PHASE_2.md](PLAN_PHASE_2.md) | Plugin System | ✅ Current (in progress) |
| 3 | [PLAN_PHASE_3.md](PLAN_PHASE_3.md) | Storage + API | ✅ Current (in progress) |
| 4 | **[PLAN_PHASE_4.md](PLAN_PHASE_4.md)** | Admin Tools | ✅ Current (in progress) |
| 5 | [PLAN_PHASE_5.md](PLAN_PHASE_5.md) | Админка Администраторы | ✅ Current (in progress) |
| 6 | [PLAN_PHASE_6.md](PLAN_PHASE_6.md) | Worklog Checker | ✅ Current (in progress) |

---

## Общая цель Фазы 4

**Было (после Фазы 3):** API для управления инструментами работает, но управлять можно только через Swagger/curl.

**Стало:** В админке появляется раздел "Инструменты" с полным UI для управления: просмотр списка, включение/выключение, настройка параметров.

**Важно:** 
- Используем существующий стек (vanilla JS, fetch API)
- Стилистика консистентна с существующей админкой
- Работает без сборщиков (как существующий код)

---

## Дизайн-требования

### Необходимые макеты от дизайнера

| # | Экран | Описание | Приоритет |
|---|-------|----------|-----------|
| 1 | Навигация | Добавить пункты меню "Инструменты", "Администраторы" | Высокий |
| 2 | Список инструментов | Карточки инструментов с статусами | Высокий |
| 3 | Настройки инструмента | Модалка с динамической формой | Высокий |

**Примечание:** Перед началом разработки UI желательно получить утверждённые дизайн-макеты. Можно начать с базовой реализации и доработать визуально позже.

---

## Архитектура UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Admin Panel                                                                │
│                                                                             │
│  ┌─────────────┐  ┌───────────────────────────────────────────────────────┐ │
│  │  Навигация  │  │                    Контент                            │ │
│  │             │  │                                                       │ │
│  │  ┌───────┐  │  │  ┌─────────────────────────────────────────────────┐  │ │
│  │  │Настр. │  │  │  │  #settings → Настройки (TG, LLM)               │  │ │
│  │  └───────┘  │  │  │                                                 │  │ │
│  │             │  │  │  #tools → Инструменты          [НОВОЕ]         │  │ │
│  │  ┌───────┐  │  │  │                                                 │  │ │
│  │  │Инстр. │◄─┼──┼──│  #admins → Администраторы      [ФАЗА 5]        │  │ │
│  │  └───────┘  │  │  │                                                 │  │ │
│  │   [НОВОЕ]   │  │  └─────────────────────────────────────────────────┘  │ │
│  │             │  │                                                       │ │
│  │  ┌───────┐  │  │                                                       │ │
│  │  │Админы │  │  │                                                       │ │
│  │  └───────┘  │  │                                                       │ │
│  │   [ФАЗА 5]  │  │                                                       │ │
│  └─────────────┘  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Файловая структура

```
admin/
├── index.html          # [РАСШИРЕНИЕ] Контейнеры для новых разделов
├── styles.css          # [РАСШИРЕНИЕ] Стили для новых компонентов
├── app.js              # [РАСШИРЕНИЕ] Роутинг, навигация
└── tools.js            # [НОВЫЙ] Логика раздела "Инструменты"
```

---

# UI Спецификации

---

## Экран 1: Навигация

### Текущее состояние
```
┌─────────────┐
│  Настройки  │  ← только один пункт
└─────────────┘
```

### Новое состояние
```
┌─────────────┐
│  Настройки  │
├─────────────┤
│ Инструменты │  ← НОВОЕ
├─────────────┤
│Администрат. │  ← НОВОЕ (заглушка для Фазы 5)
└─────────────┘
```

### Поведение
- Клик по пункту меню переключает раздел
- URL hash обновляется (#settings, #tools, #admins)
- При загрузке с hash — открывается соответствующий раздел
- Активный пункт визуально выделен

---

## Экран 2: Список инструментов

### Wireframe

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  Инструменты                                        [🔄 Перезагрузить]     │
│                                                                             │
│  Всего: 5 │ Включено: 3                                                    │
│                                                                             │
│  ┌─ Фильтр ─────────────────────────────────────────────────────────────┐  │
│  │ ○ Все (5)  ○ Включённые (3)  ○ Выключенные (1)  ○ Требуют настройки │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ── Calculator ─────────────────────────────────────────────────────────── │
│  │                                                                       │  │
│  │  calculate                                           [✅ Включён]     │  │
│  │  Evaluates mathematical expression and returns the result             │  │
│  │                                                      [Выключить]      │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ── Date & Time ────────────────────────────────────────────────────────── │
│  │                                                                       │  │
│  │  get_current_datetime                                [✅ Включён]     │  │
│  │  Returns current date and time with weekday name                      │  │
│  │                                                      [Выключить]      │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  get_weekday                                         [⏸️ Выключен]    │  │
│  │  Returns weekday for a date                                           │  │
│  │                                                      [Включить]       │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ── Worklog Checker ────────────────────────────────────────────────────── │
│  │                                                                       │  │
│  │  check_worklogs                              [⚠️ Требует настройки]   │  │
│  │  Checks employee worklogs for specified period                        │  │
│  │                                      [Настройки]  [Включить]          │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Компоненты

#### Заголовок
- Название раздела "Инструменты"
- Кнопка "Перезагрузить плагины" справа

#### Сводка
- Всего инструментов: N
- Включено: N

#### Фильтр
- Радио-кнопки: Все / Включённые / Выключенные / Требуют настройки
- Счётчик в скобках для каждого варианта

#### Карточка инструмента
- Имя инструмента (жирный)
- Описание (мелкий шрифт, серый)
- Статус-badge справа:
  - ✅ Включён (зелёный)
  - ⏸️ Выключен (серый)
  - ⚠️ Требует настройки (жёлтый)
- Кнопки действий:
  - Включить / Выключить
  - Настройки (если есть настройки у плагина)

#### Группировка
- Инструменты группируются по плагинам
- Название плагина как заголовок группы

### Взаимодействие с API

| Действие | API | Метод |
|----------|-----|-------|
| Загрузка списка | `/api/tools` | GET |
| Включение | `/api/tools/{name}/enable` | POST |
| Выключение | `/api/tools/{name}/disable` | POST |
| Перезагрузка плагинов | `/api/plugins/reload` | POST |

### Обработка состояний

| Состояние | Отображение |
|-----------|-------------|
| Загрузка | Спиннер / "Загрузка..." |
| Пустой список | "Нет инструментов" + кнопка перезагрузки |
| Ошибка | Сообщение + кнопка "Повторить" |

---

## Экран 3: Модалка настроек инструмента

### Wireframe

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Настройки: check_worklogs                                      [✕]  │  │
│  │                                                                       │  │
│  │  Плагин: Worklog Checker v1.0.0                                       │  │
│  │  Проверка ворклогов сотрудников через Jira/Tempo                      │  │
│  │                                                                       │  │
│  │  ─────────────────────────────────────────────────────────────────    │  │
│  │                                                                       │  │
│  │  Jira URL *                                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │ https://jira.company.com                                        │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │  Базовый URL вашего Jira                                              │  │
│  │                                                                       │  │
│  │  Jira Email *                                                         │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │ admin@company.com                                               │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                       │  │
│  │  Jira API Token *                                                     │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │ ••••••••••abc12                                          [👁️]  │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                       │  │
│  │  Tempo API Token *                                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │                                                          [👁️]  │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │  ⚠️ Обязательное поле                                                 │  │
│  │                                                                       │  │
│  │  Норма часов в день                                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │ 8                                                               │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                       │  │
│  │  ─────────────────────────────────────────────────────────────────    │  │
│  │                                                                       │  │
│  │  [🔌 Проверить подключение]                                           │  │
│  │                                                                       │  │
│  │  ─────────────────────────────────────────────────────────────────    │  │
│  │                                                                       │  │
│  │                                      [Отмена]  [💾 Сохранить]         │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Поддерживаемые типы полей

| Тип | Элемент | Пример |
|-----|---------|--------|
| `string` | `<input type="text">` | URL, Email |
| `password` | `<input type="password">` + toggle | API Token |
| `number` | `<input type="number">` | Норма часов |
| `boolean` | `<input type="checkbox">` | Флаг |
| `select` | `<select>` | Выбор из списка |

### Особенности полей password
- Значение отображается маскированным (как пришло из API: `***abc12`)
- Кнопка 👁️ переключает видимость
- При сохранении: если поле не изменено (`***...`) — не отправляется

### Валидация
- Обязательные поля отмечены звёздочкой *
- При сохранении с пустыми обязательными полями — ошибка под полем
- Ошибки от сервера отображаются под соответствующими полями

### Кнопка "Проверить подключение"
- Показывается если у плагина есть внешние интеграции (поля type: password)
- Вызывает `POST /api/tools/{name}/test`
- Показывает результат: успех (зелёный) или ошибка (красный)

### Взаимодействие с API

| Действие | API | Метод |
|----------|-----|-------|
| Загрузка настроек | `/api/tools/{name}` | GET |
| Сохранение | `/api/tools/{name}/settings` | PUT |
| Тест подключения | `/api/tools/{name}/test` | POST |

---

# Задачи Фазы 4

---

## Задача 4.1: Расширение навигации

### Описание
Добавить пункты меню и роутинг между разделами.

### Что сделать
1. Добавить HTML-разметку для пунктов меню
2. Добавить контейнеры для секций #tools и #admins
3. Реализовать переключение по клику
4. Реализовать роутинг по hash

### Файлы
- `admin/index.html` — разметка
- `admin/app.js` — логика роутинга

### Критерий готовности
- [ ] Три пункта меню отображаются
- [ ] Переключение работает
- [ ] Hash обновляется
- [ ] При загрузке с hash открывается нужный раздел

---

## Задача 4.2: API-функции для инструментов

### Описание
Реализовать функции для работы с API.

### Функции
```javascript
getTools()                     // GET /api/tools
getTool(name)                  // GET /api/tools/{name}
enableTool(name)               // POST /api/tools/{name}/enable
disableTool(name)              // POST /api/tools/{name}/disable
saveToolSettings(name, data)   // PUT /api/tools/{name}/settings
testToolConnection(name)       // POST /api/tools/{name}/test
reloadPlugins()                // POST /api/plugins/reload
```

### Файлы
- `admin/app.js` или отдельный `admin/api.js`

### Критерий готовности
- [ ] Все функции реализованы
- [ ] Обработка ошибок
- [ ] X-Admin-Key в заголовках

---

## Задача 4.3: Список инструментов

### Описание
Страница со списком инструментов.

### Что сделать
1. HTML-структура секции
2. Загрузка данных при открытии раздела
3. Отрисовка карточек с группировкой по плагинам
4. Статусы и badges
5. Фильтрация
6. Обработка loading/empty/error

### Файлы
- `admin/index.html` — разметка
- `admin/tools.js` — логика
- `admin/styles.css` — стили

### Критерий готовности
- [ ] Список загружается и отображается
- [ ] Группировка по плагинам
- [ ] Статусы корректны
- [ ] Фильтрация работает

---

## Задача 4.4: Включение/выключение инструментов

### Описание
Кнопки включения/выключения в карточках.

### Что сделать
1. Обработчики кнопок
2. Вызов API
3. Toast-уведомления
4. Обновление списка

### Файлы
- `admin/tools.js`

### Критерий готовности
- [ ] Включение работает
- [ ] Выключение работает
- [ ] Toast показывается
- [ ] Список обновляется

---

## Задача 4.5: Перезагрузка плагинов

### Описание
Кнопка перезагрузки плагинов.

### Что сделать
1. Обработчик кнопки
2. Вызов API
3. Loading state кнопки
4. Обновление списка

### Критерий готовности
- [ ] Кнопка работает
- [ ] Loading state
- [ ] Список обновляется

---

## Задача 4.6: Модалка настроек

### Описание
Модальное окно с формой настроек.

### Что сделать
1. HTML-структура модалки
2. Открытие/закрытие
3. Загрузка данных инструмента
4. Динамическая генерация формы

### Файлы
- `admin/index.html` — разметка модалки
- `admin/tools.js` — логика
- `admin/styles.css` — стили модалки

### Критерий готовности
- [ ] Модалка открывается по кнопке "Настройки"
- [ ] Закрытие (крестик, кнопка, backdrop)
- [ ] Данные загружаются
- [ ] Форма генерируется

---

## Задача 4.7: Типы полей формы

### Описание
Генерация полей по типу из schema.

### Типы
1. `string` — текстовое поле
2. `password` — пароль с toggle
3. `number` — числовое
4. `boolean` — чекбокс
5. `select` — выпадающий список

### Файлы
- `admin/tools.js`

### Критерий готовности
- [ ] Все типы полей работают
- [ ] Toggle пароля работает
- [ ] Обязательные поля отмечены

---

## Задача 4.8: Сохранение настроек

### Описание
Отправка формы и обработка результата.

### Что сделать
1. Сбор данных из формы
2. Отправка PUT запроса
3. Обработка успеха — закрытие, toast, обновление списка
4. Обработка ошибок валидации — подсветка полей

### Файлы
- `admin/tools.js`

### Критерий готовности
- [ ] Сохранение работает
- [ ] Ошибки валидации отображаются
- [ ] После сохранения список обновляется

---

## Задача 4.9: Тест подключения

### Описание
Кнопка проверки подключения в модалке.

### Что сделать
1. Показывать кнопку для плагинов с внешними интеграциями
2. Вызов API
3. Отображение результата

### Файлы
- `admin/tools.js`

### Критерий готовности
- [ ] Кнопка показывается когда нужно
- [ ] Тест запускается
- [ ] Результат отображается

---

## Задача 4.10: Стили

### Описание
CSS для всех новых компонентов.

### Компоненты
- Карточки инструментов
- Статус-badges
- Модальное окно
- Форма настроек
- Toast-уведомления

### Файлы
- `admin/styles.css`

### Критерий готовности
- [ ] Все компоненты стилизованы
- [ ] Консистентность с существующей админкой
- [ ] Адаптивность (responsive)

---

## Задача 4.11: Тестирование

### Ручное тестирование (чеклист)

#### Навигация
- [ ] Три пункта меню
- [ ] Переключение работает
- [ ] Hash обновляется
- [ ] Загрузка с hash работает

#### Список
- [ ] Загрузка
- [ ] Группировка
- [ ] Статусы
- [ ] Фильтрация
- [ ] Перезагрузка плагинов

#### Включение/выключение
- [ ] Включение
- [ ] Выключение
- [ ] Toast
- [ ] Обновление списка

#### Настройки
- [ ] Открытие модалки
- [ ] Загрузка данных
- [ ] Генерация формы
- [ ] Все типы полей
- [ ] Сохранение
- [ ] Валидация
- [ ] Тест подключения
- [ ] Закрытие модалки

### Критерий готовности
- [ ] Все пункты чеклиста пройдены
- [ ] Нет ошибок в консоли

---

## Последовательность работ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ДЕНЬ 1: Навигация + Список (каркас)                                       │
│                                                                             │
│  ├── 4.1 Навигация                                                         │
│  ├── 4.2 API-функции                                                       │
│  └── 4.3 Список (базовая загрузка)                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ДЕНЬ 2: Список (полная реализация)                                        │
│                                                                             │
│  ├── 4.3 Карточки, группировка, фильтрация                                 │
│  ├── 4.4 Включение/выключение                                              │
│  └── 4.5 Перезагрузка плагинов                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ДЕНЬ 3: Модалка настроек                                                   │
│                                                                             │
│  ├── 4.6 Модалка (структура)                                               │
│  ├── 4.7 Типы полей                                                        │
│  └── 4.8 Сохранение                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ДЕНЬ 4: Доработка + Стили                                                  │
│                                                                             │
│  ├── 4.9 Тест подключения                                                  │
│  └── 4.10 Стили                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ДЕНЬ 5: Тестирование                                                       │
│                                                                             │
│  ├── 4.11 Ручное тестирование                                              │
│  └── Исправление багов                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  РЕЗУЛЬТАТ ФАЗЫ 4                                                          │
│                                                                             │
│  ✅ Раздел "Инструменты" в админке                                         │
│  ✅ Список с группировкой и фильтрацией                                    │
│  ✅ Включение/выключение                                                    │
│  ✅ Настройка через модалку                                                 │
│  ✅ Тест подключения                                                        │
│  ✅ Перезагрузка плагинов                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Definition of Done для Фазы 4

- [ ] Все задачи 4.1-4.11 выполнены
- [ ] Навигация работает
- [ ] Список инструментов работает
- [ ] Включение/выключение работает
- [ ] Настройки сохраняются
- [ ] Тест подключения работает
- [ ] Перезагрузка плагинов работает
- [ ] Ручное тестирование пройдено
- [ ] Нет ошибок в консоли

---

## Что НЕ входит в Фазу 4

- ❌ Раздел "Администраторы" (Фаза 5)
- ❌ Бизнес-плагины (Фаза 6)
- ❌ Unit-тесты для JS

---

## Версионирование документа

| Версия | Дата | Описание |
|--------|------|----------|
| 1.0 | 2026-02-06 | Первая версия плана Фазы 4 |
