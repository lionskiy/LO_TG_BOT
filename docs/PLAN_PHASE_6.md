# PHASE 6: Worklog Checker (бизнес-плагин)

> **Детальная постановка задач для Фазы 6**  
> Первый бизнес-плагин: проверка ворклогов сотрудников через Jira и Tempo

**Версия:** 1.0  
**Дата:** 2026-02-06  
**Ориентировочный срок:** 1–2 недели  
**Предусловие:** Фазы 0–4 завершены (Plugin System, Storage, API, админка «Инструменты» работают)

---

## Связанные документы

| Документ | Описание | Статус |
|----------|----------|--------|
| [ARCHITECTURE_BLUEPRINT.md](ARCHITECTURE_BLUEPRINT.md) | Целевая архитектура системы | ✅ Актуален (не завершено) |
| [UPGRADE_TASKS.md](UPGRADE_TASKS.md) | Декомпозиция всех задач (блок 7.1) | ✅ Актуален (не завершено) |
| [PLAN_PHASE_0_1.md](PLAN_PHASE_0_1.md) | Детальный план Фазы 0-1 | ✅ Актуален (не завершено) |
| [PLAN_PHASE_2.md](PLAN_PHASE_2.md) | Детальный план Фазы 2 | ✅ Актуален (не завершено) |
| [PLAN_PHASE_3.md](PLAN_PHASE_3.md) | Детальный план Фазы 3 | ✅ Актуален (не завершено) |
| [PLAN_PHASE_4.md](PLAN_PHASE_4.md) | Детальный план Фазы 4 | ✅ Актуален (не завершено) |
| [PLAN_PHASE_5.md](PLAN_PHASE_5.md) | Детальный план Фазы 5 | ✅ Актуален (не завершено) |
| [PLAN_PHASE_6.md](PLAN_PHASE_6.md) | Детальный план Фазы 6 (этот документ) | ✅ Актуален (не завершено) |

---

## Навигация по фазам

| Фаза | Документ | Описание | Статус |
|------|----------|----------|--------|
| 0-1 | [PLAN_PHASE_0_1.md](PLAN_PHASE_0_1.md) | Стабилизация + Tool-Calling | ✅ Актуален (не завершено) |
| 2 | [PLAN_PHASE_2.md](PLAN_PHASE_2.md) | Plugin System | ✅ Актуален (не завершено) |
| 3 | [PLAN_PHASE_3.md](PLAN_PHASE_3.md) | Storage + API | ✅ Актуален (не завершено) |
| 4 | [PLAN_PHASE_4.md](PLAN_PHASE_4.md) | Админка Инструменты | ✅ Актуален (не завершено) |
| 5 | [PLAN_PHASE_5.md](PLAN_PHASE_5.md) | Админка Администраторы | ✅ Актуален (не завершено) |
| 6 | **[PLAN_PHASE_6.md](PLAN_PHASE_6.md)** | Worklog Checker | ✅ Актуален (не завершено) |

### Текущая реализация (v1.0)

| Документ | Описание |
|----------|----------|
| [TG_Project_Helper_v1.0.md](TG_Project_Helper_v1.0.md) | Спецификация текущей реализации |
| [TG_Project_Helper_v1.0_QUICKSTART.md](TG_Project_Helper_v1.0_QUICKSTART.md) | Быстрый старт и FAQ |

---

## Общая цель Фазы 6

**Было:** В системе есть плагины (calculator, datetime_tools), инструменты настраиваются через админку, но нет бизнес-интеграций.

**Стало:** Появляется плагин **Worklog Checker**, который по запросу пользователя (через бота) проверяет ворклоги сотрудников за период: получает данные из Jira (пользователь, задачи) и из Tempo (фактические часы), сравнивает с нормой и возвращает сводку (дефицит/переработка, список задач).

**Важно:**

- Плагин оформлен по стандарту (plugin.yaml, handlers.py), настройки хранятся в БД через общий механизм (Фаза 3).
- Внешние вызовы — только к Jira REST API и Tempo API (или Tempo Reports API в зависимости от выбранной версии API).
- Документ задаёт **только спецификации и постановки задач**, без реализации кода.

---

## Назначение плагина

- **Пользователь в Telegram:** «Проверь ворклоги Иванова за эту неделю» / «Сводка по команде за месяц».
- **Бот:** вызывает инструмент плагина с параметрами (сотрудник/команда, период).
- **Плагин:** запрашивает настройки (Jira URL, токены), обращается к Jira и Tempo, считает норму часов за период (с учётом рабочих дней и требуемых часов в день), возвращает структурированный результат.
- **LLM:** форматирует ответ пользователю на естественном языке.

---

## Внешние системы

### Jira (Cloud или Server/Data Center)

- **Назначение:** получение пользователя по имени/email (поиск), при необходимости — список задач пользователя за период (для контекста).
- **Аутентификация:** Jira Cloud — API Token + email; Jira Server — Personal Access Token или Basic (user/token). В спецификации учитывать оба варианта (в настройках плагина — отдельные поля при необходимости).
- **Типовые запросы:**
  - Поиск пользователя: REST API (например, пользователь по displayName или по accountId, в зависимости от версии Jira).
  - Список задач (опционально): JQL по assignee и датам.
- **Документация:** [Jira REST API](https://developer.atlassian.com/cloud/jira/platform/rest/v3/).

### Tempo (Tempo Timesheets / Tempo API)

- **Назначение:** получение ворклогов (worklogs) за период для пользователя (по accountId или user key).
- **Аутентификация:** API Token (Tempo API token в настройках аккаунта).
- **Типовые запросы:**
  - Worklogs за период: эндпоинт вида `/worklogs` с параметрами user (или accountId), from, to.
- **Документация:** [Tempo API](https://apidocs.tempo.io/) (актуальную версию уточнять по официальному сайту Tempo).

**Важно:** Версии API Jira Cloud и Tempo могут отличаться (v2/v3, OAuth vs token). В спецификации зафиксировать: поддержка Jira Cloud + Tempo API с токенами; при необходимости отдельный подраздел «Ограничения и варианты (Jira Server)».

---

## Структура плагина

### Каталог и файлы

```
plugins/
└── worklog_checker/
    ├── plugin.yaml          # Манифест: id, name, version, tools, settings
    ├── handlers.py          # Обработчики инструментов (check_worklogs, get_worklog_summary)
    ├── jira_client.py       # [Вспомогательный] Клиент Jira REST API
    ├── tempo_client.py      # [Вспомогательный] Клиент Tempo API
    └── (опционально) test_connection.py  # Проверка подключения для кнопки в админке
```

### plugin.yaml — манифест

Спецификация содержимого (без реализации):

- **id:** `worklog-checker`
- **name:** «Проверка ворклогов» (или «Worklog Checker»)
- **version:** `1.0.0`
- **enabled по умолчанию:** `false` (плагин требует настройки Jira/Tempo)
- **tools:**
  - **check_worklogs**
    - **description:** на английском, для LLM: проверка ворклогов сотрудника за период; возвращает залогированные часы, норму, дефицит/переработку, список задач (кратко).
    - **parameters (JSON Schema):**
      - `employee` (string, required): имя/фамилия/email сотрудника или часть для поиска в Jira.
      - `period` (string, required): период, например `this_week`, `last_week`, `this_month`, `last_month` или даты в формате `YYYY-MM-DD/YYYY-MM-DD`.
    - **timeout:** 60 (секунд)
  - **get_worklog_summary**
    - **description:** сводка по ворклогам команды/нескольких сотрудников за период (суммы по людям, общая картина).
    - **parameters:**
      - `team` (string, optional): название команды или перечень имён/идентификаторов (формат уточняется — список через запятую или один идентификатор группы в Jira).
      - `period` (string, required): тот же формат, что и в check_worklogs.
    - **timeout:** 90
- **settings (схема для админки и валидации):**
  - `jira_url` (string, required): базовый URL Jira, например `https://company.atlassian.net`
  - `jira_email` (string, required для Cloud): email для Jira Cloud API token
  - `jira_token` (password, required): API Token (Cloud) или PAT (Server)
  - `tempo_token` (password, required): Tempo API token
  - `required_hours_per_day` (number, optional): норма часов в день (по умолчанию 8)
  - `working_days` (string, optional): рабочие дни, например `mon,tue,wed,thu,fri` (по умолчанию пн–пт)

При необходимости в манифесте указывается наличие **test handler** для кнопки «Проверить подключение» в админке (см. ниже).

---

## Инструменты — спецификация поведения

### 1. check_worklogs(employee, period)

- **Вход:** `employee` (строка), `period` (строка).
- **Логика (пошагово):**
  1. Загрузка настроек плагина (get_plugin_settings).
  2. Парсинг периода: преобразование `this_week` / `last_week` / `this_month` / `last_month` в даты начала и конца (по локальной таймзоне или UTC — зафиксировать в спеках).
  3. Поиск пользователя в Jira по `employee` (displayName, email или accountId — в зависимости от API).
  4. Получение ворклогов из Tempo для найденного пользователя за период (from, to).
  5. Расчёт нормы часов: число рабочих дней в периоде × required_hours_per_day (working_days учитываются).
  6. Суммирование фактических часов из ворклогов.
  7. Формирование результата: employee (display name), period (диапазон дат), logged_hours, required_hours, deficit_or_surplus (дефицит/переработка), список задач (ключ задачи, сумма часов по задаче) — структура для JSON.
- **Выход:** строка (сериализованный JSON или читаемый текст) для возврата в LLM; при ошибке — сообщение об ошибке (без падения процесса).
- **Ошибки:** пользователь не найден, нет доступа к Tempo/Jira, таймаут — обрабатываются и возвращаются как текст ошибки в ответе инструмента.

### 2. get_worklog_summary(team, period)

- **Вход:** `team` (опционально), `period` (обязательно).
- **Логика:**
  1. Загрузка настроек, парсинг периода.
  2. Определение списка пользователей: если `team` задан — разрешение команды в список пользователей (через Jira API группы/проекта или заранее заданный список в настройках — уточнить в спеках); если не задан — по возможности все пользователи с ворклогами за период (или ограниченный список).
  3. Для каждого пользователя — запрос ворклогов за период (Tempo).
  4. Агрегация: по каждому сотруднику — logged_hours, required_hours, deficit; общая сводка по периоду.
- **Выход:** структурированный результат (JSON-подобная строка или dict, сериализованный в строку).
- **Ошибки:** те же принципы, что и для check_worklogs.

Спецификация не предписывает конкретный формат JSON-полей (имена ключей), но он должен быть зафиксирован в этом документе или в отдельном «Контракт ответа» внутри Фазы 6, чтобы LLM и тесты могли на него опираться.

---

## Вспомогательные модули (контракт, без реализации)

### jira_client

- **Назначение:** обёртка над HTTP-запросами к Jira REST API.
- **Методы (контракт):**
  - **search_user(query: str) -> dict | None:** поиск пользователя по имени/email; возвращает объект с полями, необходимыми для Tempo (например accountId, displayName).
  - **get_issues_for_user(account_id: str, date_from, date_to) -> list[dict] (опционально):** список задач пользователя за период (если нужен для обогащения ответа).
- **Аутентификация:** из настроек плагина (jira_url, jira_email, jira_token или аналог для Server).
- **Обработка ошибок:** HTTP 401/403/404 — логирование и выброс исключения или возврат None/пустого списка по соглашению; таймауты — обрабатывать и не ронять процесс.

### tempo_client

- **Назначение:** обёртка над Tempo API (worklogs).
- **Методы (контракт):**
  - **get_worklogs(user_identifier: str, date_from, date_to) -> list[dict]:** ворклоги пользователя за период. `user_identifier` — accountId (Jira Cloud) или user key (Jira Server); формат дат — по документации Tempo.
  - Каждый элемент списка содержит как минимум: ключ задачи (issue key), часы (или секунды — привести к часам в логике плагина), дату.
- **Аутентификация:** tempo_token из настроек.
- **Обработка ошибок:** аналогично jira_client.

Конкретные URL эндпоинтов (Tempo v2/v3 и т.д.) указать в спеках или в отдельной таблице «Эндпоинты» в этом документе, чтобы реализация была однозначной.

---

## Проверка подключения (test handler)

- **Назначение:** для кнопки «Проверить подключение» в админке (если плагин поддерживает test в plugin.yaml).
- **Поведение:** один запрос к Jira (например, текущий пользователь или поиск по фиксированной строке) и один запрос к Tempo (минимальный диапазон дат или проверка токена). Результат: `{ "jira_ok": true|false, "tempo_ok": true|false, "errors": [...] }`.
- **Возврат:** строка (JSON) или dict — по соглашению с общим механизмом test в админке.

---

## Задачи Фазы 6 (декомпозиция)

Задачи ниже — постановки для реализации, без написания кода.

---

### Задача 6.1: Манифест и структура плагина

- Описание: создать каталог `plugins/worklog_checker`, файл `plugin.yaml` по спецификации выше (id, name, version, tools с параметрами и timeout, settings с типами и required).
- Критерий готовности: плагин подхватывается Plugin Loader, в Registry отображаются два инструмента (check_worklogs, get_worklog_summary), в админке отображаются настройки плагина; при отсутствии настроек инструменты в статусе «требует настройки».

---

### Задача 6.2: Jira client (контракт и реализация)

- Описание: реализовать модуль `jira_client` с методами search_user и при необходимости get_issues_for_user; аутентификация и обработка ошибок по спекам.
- Критерий готовности: по имени/email возвращается пользователь с accountId/displayName; ошибки 401/403/404 и таймауты обрабатываются без падения процесса.

---

### Задача 6.3: Tempo client (контракт и реализация)

- Описание: реализовать модуль `tempo_client` с методом get_worklogs; аутентификация и обработка ошибок.
- Критерий готовности: по user identifier и периоду возвращается список ворклогов с полями issue key и часы; ошибки обрабатываются.

---

### Задача 6.4: Парсинг периода (period)

- Описание: функция преобразования строки периода (`this_week`, `last_week`, `this_month`, `last_month`, `YYYY-MM-DD/YYYY-MM-DD`) в даты начала и конца (date_from, date_to). Учесть working_days и таймзону (UTC или локальную — зафиксировать).
- Критерий готовности: для каждой допустимой строки периода возвращается корректный диапазон дат; невалидный формат обрабатывается с понятной ошибкой.

---

### Задача 6.5: Обработчик check_worklogs

- Описание: в handlers.py реализовать асинхронный обработчик check_worklogs(employee, period): загрузка настроек, поиск пользователя (Jira), получение ворклогов (Tempo), расчёт нормы и дефицита/переработки, формирование результата в согласованном формате (JSON-строка или текст).
- Критерий готовности: вызов из бота/LLM с параметрами employee и period возвращает осмысленный результат; при отсутствии пользователя или ошибке API возвращается сообщение об ошибке в формате ответа инструмента.

---

### Задача 6.6: Обработчик get_worklog_summary

- Описание: реализовать get_worklog_summary(team, period) по спекам: определение списка пользователей (по team или иному правилу), агрегация ворклогов, сводка по сотрудникам и общая.
- Критерий готовности: вызов с period возвращает сводку; при задании team (если реализовано) — фильтрация по команде; ошибки обрабатываются.

---

### Задача 6.7: Test handler (опционально)

- Описание: реализовать проверку подключения к Jira и Tempo (отдельная функция или handler), зарегистрировать в plugin.yaml как test (если стандарт плагинов это поддерживает).
- Критерий готовности: в админке кнопка «Проверить подключение» для плагина Worklog Checker возвращает результат вида jira_ok, tempo_ok, errors.

---

### Задача 6.8: Документация и контракты ответов

- Описание: зафиксировать в docs или в комментариях плагина формат возвращаемых структур (check_worklogs, get_worklog_summary) и список поддерживаемых значений period; при необходимости — таблица эндпоинтов Jira/Tempo с версиями API.
- Критерий готовности: разработчик и тесты могут опираться на описание формата ответа и периодов.

---

### Задача 6.9: Ручное и E2E тестирование

- Описание: сценарии: добавление плагина, настройка Jira/Tempo в админке, проверка подключения, запрос из бота «Проверь ворклоги [имя] за эту неделю» и «Сводка за месяц», проверка ответа LLM и отсутствия падений при ошибках (неверный токен, пользователь не найден).
- Критерий готовности: все сценарии пройдены; при ошибках API пользователь получает понятное сообщение, а не сырой traceback.

---

## Последовательность работ

```
Неделя 1:
├── 6.1 Манифест и структура плагина
├── 6.2 Jira client
├── 6.3 Tempo client
└── 6.4 Парсинг периода

Неделя 2:
├── 6.5 Обработчик check_worklogs
├── 6.6 Обработчик get_worklog_summary
├── 6.7 Test handler (опционально)
├── 6.8 Документация и контракты
└── 6.9 Тестирование
```

---

## Definition of Done для Фазы 6

- [ ] Плагин worklog_checker загружается и отображается в админке
- [ ] Настройки (Jira URL, токены, часы, рабочие дни) сохраняются и используются
- [ ] Инструмент check_worklogs возвращает ворклоги и дефицит/переработку за период
- [ ] Инструмент get_worklog_summary возвращает сводку (по команде или за период)
- [ ] Ошибки Jira/Tempo обрабатываются и не роняют процесс
- [ ] Проверка подключения из админки работает (если реализован test handler)
- [ ] Ручное/E2E тестирование пройдено

---

## Риски и ограничения

- **Версии API:** Jira Cloud REST API v3 и Tempo API могут менять эндпоинты; зафиксировать поддерживаемые версии в документации плагина.
- **Jira Server:** при необходимости поддержки Server — отдельная ветка настроек (другой тип аутентификации) и тесты.
- **Лимиты Tempo/Jira:** при большом количестве ворклогов может потребоваться пагинация; учесть в контракте tempo_client и в обработчиках.
- **Таймзоны:** единая политика (UTC или локальная таймзона сервера) для расчёта «рабочих дней» и периодов — зафиксировать в спеках.

---

## Что НЕ входит в Фазу 6

- Другие бизнес-плагины (HR Service, Reminder)
- Изменения в ядре Plugin System (кроме возможных доработок по test handler, если они потребуются)
- Автоматическая отправка напоминаний (это плагин Reminder)
- Поддержка Jira Server без предварительной фиксации требований в отдельной спецификации

---

## Версионирование документа

| Версия | Дата | Описание |
|--------|------|----------|
| 1.0 | 2026-02-06 | Первая версия плана Фазы 6 |
