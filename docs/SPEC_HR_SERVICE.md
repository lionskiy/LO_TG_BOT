# Спецификация плагина HR Service

> **Назначение:** ТЗ для разработки плагина hr_service — справочник сотрудников, импорт из Excel, дообогащение из Jira, правки через бота и админку.  
> **Ветка:** docs_creation  
> **Версия:** 1.0  
> **Дата:** 2026-02-07

---

## 1. Цель и границы

- **Цель:** единая БД сотрудников для использования ботом и другими плагинами (worklog_checker, напоминальщик и т.д.). Заполнение и обновление — из входящих файлов Excel, из Jira (дообогащение worker_id), через Telegram-бота и через веб-админку.
- **Зависимости:** плагин не зависит от других плагинов. Работа только с входящими файлами и своей БД. Интеграция с Jira — только внутри hr_service (получение userKey для проставления jira_worker_id).
- **Принцип:** общая БД — единый источник правды; плагины не вызывают друг друга, только читают/пишут БД. Очередность выполнения задач между плагинами не через вызовы, а через порядок выполнения (например, напоминальщик работает после того, как в БД уже есть нужные данные от других плагинов).

---

## 2. Модель данных

### 2.1. Таблица сотрудников (одна общая таблица)

Используется одна таблица. Роли «руководитель» и «деливери-менеджер» задаются флагами и полем команды.

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| id | PK, auto | да | Системный идентификатор записи |
| personal_number | string, unique | да | Табельный номер сотрудника |
| full_name | string | да | ФИО (полное) |
| email | string | да | Почта; используется как логин в Jira и Mattermost |
| jira_worker_id | string, nullable | нет | Идентификатор пользователя в Jira (JIRAUSER***). Заполняется при дообогащении из Jira |
| position | string, nullable | нет | Должность |
| mvz | string, nullable | нет | МВЗ (наименование подразделения) |
| supervisor | string, nullable | нет | Руководитель (ФИО или табельный — на усмотрение реализации) |
| hire_date | date, nullable | нет | Дата приёма на работу |
| fte | decimal, default 1 | да | Ставка (1 = полная). Меняется админами (в т.ч. 0 при увольнении) |
| dismissal_date | date, nullable | нет | Дата увольнения. Если задана — сотрудник не участвует в расчётах (например, в worklog_checker) |
| birth_date | date, nullable | нет | День рождения (опционально) |
| mattermost_username | string, nullable | нет | Имя в Mattermost; по умолчанию при создании = email |
| is_supervisor | boolean, default false | да | Является руководителем (ручное или через бота/админку) |
| is_delivery_manager | boolean, default false | да | Является деливери-менеджером |
| team | string, nullable | нет | Название команды (для менеджеров — чей они менеджер; для сотрудников — привязка к команде). Варианты написания одной команды: SE, Search, Поиск — нормализуются/сопоставляются на уровне справочника или правил, задаётся вручную |
| created_at | datetime | да | Системное, момент создания |
| updated_at | datetime | да | Системное, момент последнего обновления |

Индексы: по `personal_number` (уникальный), по `email`, по `jira_worker_id` (для быстрого поиска при обогащении и работе ворклог-чекера).

### 2.2. Представления в админке (без отдельных таблиц)

- **Списки сотрудников** — все записи из таблицы сотрудников.
- **Руководители и МВЗ** — фильтр по `is_supervisor = true`.
- **Деливери менеджеры** — фильтр по `is_delivery_manager = true` (с отображением поля team).

Данные для этих ролей не загружаются отдельными файлами: заполняются вручную в админке или через бота (например: «Иванов — руководитель МВЗ X» → обновление записи Иванова: is_supervisor = true, при необходимости mvz/supervisor). Допускается функционал «предложить руководителей/менеджеров» по общему списку (умный вывод или ручной выбор).

---

## 3. Импорт из файла

### 3.1. Кто может загружать файл

Загружать файл в бота и запускать импорт могут **только сервисные администраторы** (пользователи из списка service_admins). Остальные пользователи не могут инициировать импорт.

### 3.2. Формат файла

- **Форматы:** .xlsx и .xls.
- **Листы:** ровно два листа с фиксированными именами:
  - **Лист 1 — «ДДЖ»**
  - **Лист 2 — «Инфоком»**

Оба листа содержат списки сотрудников (не раздельные списки «только руководители» или «только менеджеры»). Структура колонок на каждом листе фиксирована для маппинга.

### 3.3. Маппинг колонок

**Лист «ДДЖ»**

| Колонка в файле | Поле в БД | Примечание |
|-----------------|-----------|------------|
| Табельный номер | personal_number | Уникальный |
| ФИО | full_name | |
| должность | position | |
| Текст Основное МВЗ | mvz | Название МВЗ |
| МВЗ (номер) | — | Не использовать |
| Дата приема | hire_date | |
| почта | email | Также проставляется mattermost_username = email при создании записи |
| руководитель | supervisor | |

**Лист «Инфоком»**

Колонки «4 уровень наим. подразделения» … «9 уровень наим. подразделения», «НазванГруппСотрудник», МВЗ (номер) — **не используются**.

| Колонка в файле | Поле в БД | Примечание |
|-----------------|-----------|------------|
| Полное наименование штатной до | position | |
| Табельный № (первое вхождение по порядку колонок) | personal_number | Уникальный |
| Табельный номер (колонка с ФИО) | full_name | В этом листе в колонке «Табельный номер» хранится ФИО |
| Дата приема | hire_date | |
| Табельный № (второе вхождение — табельный номер руководителя) | — | Можно использовать для связи с руководителем при необходимости |
| Табельный номер начальника (Ор… ) / ФИО руководителя | supervisor | |
| МВЗ (название) | mvz | Наименование МВЗ |
| почта | email | mattermost_username = email при создании |

При разборе листов необходимо однозначно идентифицировать колонки по заголовкам (и при необходимости по порядку), чтобы различать два «Табельный №» и колонку «Табельный номер» с ФИО на листе «Инфоком».

### 3.4. Логика импорта

1. **Проверка отправителя:** только сервисный админ. Иначе — отказ без обработки файла.
2. **Парсинг:** оба листа «ДДЖ» и «Инфоком» разбираются по маппингу выше.
3. **Объединение по табельному номеру:** данные двух листов объединяются по полю `personal_number`. Если один и тот же табельный номер встречается на обоих листах — объединение полей: для каждой колонки брать непустое значение (при обоих непустых — приоритет листа «ДДЖ» для полей с этого листа, «Инфоком» — для полей с этого листа; при дублировании поля на двух листах — приоритет задаётся в реализации, например «ДДЖ» основной).
4. **Дубликаты внутри файла:** если в итоговом наборе по одному файлу один и тот же табельный номер встречается более одного раза (например, дважды на одном листе) — **ошибка**: такие строки не импортируются, в отчёт включается факт ошибки.
5. **Сверка с БД:**
   - Записи с табельным номером, который **уже есть** в БД, — **пропускаем** (не обновляем и не дублируем).
   - Записи с табельным номером, которого **нет** в БД, — **вставляем** как новые (создаём запись с заполненными полями из файла; jira_worker_id изначально NULL; fte = 1; dismissal_date = NULL; is_supervisor, is_delivery_manager = false; team = NULL; mattermost_username = email).
6. **Дообогащение из Jira:** после успешного импорта для **всех новых** сотрудников, у которых `jira_worker_id` пустой, запускается дообогащение (см. раздел 5): запрос к Jira API по email/username → получение userKey (JIRAUSER***) → запись в поле `jira_worker_id`.
7. **Обратная связь пользователю в Telegram:** после обработки файла отправителю отправляется сообщение: файл обработан, добавлено N новых сотрудников. Если новых не более 10 — перечислить фамилии (например, из поля full_name); если больше 10 — только число. При ошибках (дубликаты в файле, ошибки парсинга) — кратко указать факт и количество ошибок.

---

## 4. Инструменты плагина (tools)

Инструменты вызываются ботом (LLM решает, когда вызвать) или при обработке вложений.

| Инструмент | Назначение | Кто может вызывать (запись) |
|------------|------------|-----------------------------|
| **import_employees** | Импорт из приложенного файла (файл передаётся в контексте вызова). Парсинг, сверка по personal_number, запись новых, дообогащение из Jira, ответ пользователю. | Только сервисные админы |
| **get_employee** | Получить данные по одному сотруднику (по ФИО, табельному номеру или email). | Все пользователи бота (чтение) |
| **list_employees** | Список сотрудников с опциональными фильтрами (МВЗ, команда, только руководители и т.д.). | Все (чтение) |
| **search_employees** | Поиск по имени, подразделению, должности и т.д. | Все (чтение) |
| **update_employee** | Обновить поля сотрудника (ставка, дата увольнения, is_supervisor, is_delivery_manager, team и т.д.). Поиск по ФИО; при наличии табельного номера — по нему; при однофамильцах — уточнение. | Только сервисные админы |

Проверка «сервисный админ» выполняется при вызове инструментов, меняющих данные (import_employees, update_employee). Для get_employee, list_employees, search_employees проверка на админа не требуется (доступно всем).

Команды в естественном языке (например: «У Беспаловой ставка 0,5», «Беспалова уволена с 01.02.2025») обрабатываются через **update_employee**: LLM извлекает сущность (Беспалова), поле (fte или dismissal_date) и значение, после чего вызывается один инструмент с соответствующими параметрами. Поиск сотрудника: по ФИО; если в сообщении есть табельный номер — по нему; если найдено несколько (однофамильцы) — бот уточняет, кому вносить изменение.

Назначение «руководитель» / «деливери-менеджер» и привязка к команде: через **update_employee** (например: установить is_supervisor = true, mvz; или is_delivery_manager = true, team). Допускается функционал «предложить руководителей/менеджеров» по общему списку (логика вывода может быть эвристической или ручной выбор в админке).

---

## 5. Дообогащение данными из Jira (вариант B)

- **Место реализации:** только внутри плагина hr_service. Другие плагины (worklog_checker и т.д.) не вызываются; они лишь читают из БД поле `jira_worker_id`.
- **Настройки:** в настройках плагина hr_service задаются URL Jira и токен (аналогично worklog_checker). Tempo для этой операции не используется; userKey берётся из Jira REST API (см. [tempo_api.md](tempo_api.md)).
- **Когда запускается:** автоматически после каждого успешного импорта файла — для всех **новых** добавленных сотрудников, у которых `jira_worker_id` пустой. Запрос к Jira: по email (или username, извлечённому из email) — GET user → поле `key` (userKey, формат JIRAUSER***) → запись в `jira_worker_id`.
- **Поведение при ошибке:** если для части сотрудников не удалось получить userKey (нет в Jira, ошибка API) — не блокировать импорт; записать тех, кого удалось обогатить; при необходимости залогировать или вернуть в отчёте пользователю количество не обогащённых.

---

## 6. Обработка в Telegram-боте

### 6.1. Вложение — файл

- Пользователь отправляет боту файл (возможно с текстом/командой).
- Если в сообщении есть текст — бот его обрабатывает (команда или уточнение). По умолчанию при **только файле** (без текста или с нейтральным текстом): бот определяет, что это файл, и передаёт его в плагин hr_service (инструмент import_employees). Импорт выполняется только если отправитель — сервисный админ; иначе — сообщение об отказе.

### 6.2. Команды на изменение

- Примеры: «У Беспаловой ставка 0,5», «Измени ставку у Беспаловой на 0,5», «Беспалова уволена с 01.02.2025».
- Обработка: hr_service, инструмент **update_employee**. Поиск по ФИО; при указании табельного номера — по нему; при однофамильцах — уточнение у пользователя. Обновление выполняется только для сервисных админов.

### 6.3. Права

- **Чтение** (get_employee, list_employees, search_employees): все пользователи бота.
- **Запись** (import_employees, update_employee): только сервисные администраторы.

---

## 7. Админ-панель — раздел «Работа с БД»

### 7.1. Размещение

- В админке добавляется пункт меню **«Работа с БД»** (или «Списки сотрудников» — по решению продукта; в спецификации зафиксировано «Работа с БД»).
- Страница доступна по отдельному URL (например, `/admin/#db` или отдельная страница).

### 7.2. Верхнее меню на странице (подменю)

Три переключаемых представления одной таблицы сотрудников (фильтры):

1. **Списки сотрудников** — все записи.
2. **Руководители и МВЗ** — записи с `is_supervisor = true`.
3. **Деливери менеджеры** — записи с `is_delivery_manager = true` (с отображением поля team).

Переключение между ними без перезагрузки страницы; таблица одна и та же по структуре колонок.

### 7.3. Таблица

- Визуализация данных из БД: строки — сотрудники, колонки — поля таблицы (в соответствии с моделью данных). Названия колонок и набор полей **жёстко заданы**, добавлять/удалять колонки пользователь не может.
- Редактирование **в ячейках** (как в таблице Excel): клик по ячейке → ввод/изменение значения → сохранение. Изменения записываются в БД (обновление соответствующей записи). Права на редактирование в админке те же, что и для API: фактически доступ к разделу «Работа с БД» подразумевает право на изменение (например, только для авторизованных админов).
- Добавление новых строк (новых сотрудников) через интерфейс — при необходимости может быть вынесено в отдельное требование; в базовой спецификации достаточно импорта из файла и правки существующих записей.

---

## 8. Технические замечания

- **Контракт ошибок инструментов:** единый формат ответа при ошибке (например, строка вида "Error: …" или JSON с полем error) — для согласованности с остальными плагинами (см. DOCUMENTATION_AUDIT).
- **Файл в Telegram:** механизм передачи файла из бота в инструмент (путь к скачанному файлу, временный файл, тип .xlsx/.xls) и проверка формата — в зоне ответственности ядра/бота и плагина; в реализации учесть ограничения размера и безопасность.
- **Названия команд (team):** варианты вроде SE, Search, Поиск для одной команды на первом этапе могут храниться «как есть»; нормализация или справочник команд — при необходимости в следующих итерациях.

---

## 9. Версионирование документа

| Версия | Дата | Описание |
|--------|------|----------|
| 1.0 | 2026-02-07 | Первая версия спецификации: модель данных, импорт из двух листов ДДЖ/Инфоком, дообогащение из Jira (вариант B), инструменты, права, админка «Работа с БД» |
