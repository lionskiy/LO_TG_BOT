# План работ: HR Service

> **Назначение:** пошаговый план реализации плагина hr_service с отметкой выполнения.  
> **Спецификация:** [SPEC_HR_SERVICE.md](SPEC_HR_SERVICE.md)  
> **Дата:** 2026-02-07

---

## Как пользоваться

- Отмечайте выполнение: заменяйте `- [ ]` на `- [x]` по мере завершения задачи.
- Порядок блоков учитывает зависимости (БД → плагин → API → админка; бот можно параллельно с API).
- Детали по каждому пункту — в [SPEC_HR_SERVICE.md](SPEC_HR_SERVICE.md).

---

## 1. База данных и модель

- [x] **1.1** Таблица сотрудников
  - [x] 1.1.1 Определить имя таблицы (`employees` или `hr_employees`) и размещение в той же SQLite, что и telegram_settings / tool_settings.
  - [x] 1.1.2 Реализовать схему: все поля по SPEC разд. 2.1 (id, personal_number, full_name, email, jira_worker_id, position, mvz, supervisor, hire_date, fte, dismissal_date, birth_date, mattermost_username, is_supervisor, is_delivery_manager, team, created_at, updated_at).
  - [x] 1.1.3 Индексы: unique по `personal_number`, по `email`, по `jira_worker_id`.
- [x] **1.2** Создание таблицы
  - [x] 1.2.1 Миграция (Alembic) или скрипт инициализации при первом обращении к БД / при старте приложения.
  - [x] 1.2.2 Проверка: таблица создаётся и доступна из кода плагина.

---

## 2. Плагин hr_service (структура и регистрация)

- [x] **2.1** Манифест и регистрация
  - [x] 2.1.1 Создать каталог `plugins/hr_service/`.
  - [x] 2.1.2 Файл `plugin.yaml`: id, name, version, description, enabled; один инструмент (например, `name: hr`) с параметром `action` и описанием параметров по SPEC разд. 4.2.
  - [x] 2.1.3 Секция `settings`: jira_url, api_token (и при необходимости jira_email / jira_username).
  - [x] 2.1.4 Плагин загружается через общий Plugin Loader; отображается в админке «Инструменты».
- [x] **2.2** Handler и dispatch
  - [x] 2.2.1 Файл `handlers.py`: один handler (например, `hr_dispatch`), принимает `action` и аргументы.
  - [x] 2.2.2 По `action` вызываются: get_employee, list_employees, search_employees, update_employee, import_employees.
  - [x] 2.2.3 Контракт ошибок: единый формат (например, "Error: …" или JSON с полем error) по DOCUMENTATION_AUDIT.

---

## 3. Функции плагина (чтение и обновление)

- [x] **3.1** get_employee
  - [x] 3.1.1 Поиск по ФИО, табельному номеру или email.
  - [x] 3.1.2 Возврат данных одной записи или сообщение об отсутствии.
- [x] **3.2** list_employees
  - [x] 3.2.1 Список с опциональными фильтрами (МВЗ, команда, только руководители, только деливери-менеджеры).
  - [x] 3.2.2 Пагинация при необходимости (на усмотрение реализации).
- [x] **3.3** search_employees
  - [x] 3.3.1 Поиск по имени, подразделению, должности и т.д.
- [x] **3.4** update_employee
  - [x] 3.4.1 Обновление полей записи (ставка, дата увольнения, is_supervisor, is_delivery_manager, team, mvz, supervisor и т.д.).
  - [x] 3.4.2 Поиск по ФИО или табельному номеру; при однофамильцах — возможность уточнения (возврат списка кандидатов).
  - [x] 3.4.3 Проверка «сервисный админ» при вызове из бота (по Telegram ID) — только для этой функции и import_employees; в API админки проверка доступа к админке.

---

## 4. Импорт из Excel

- [x] **4.1** Парсинг файла
  - [x] 4.1.1 Поддержка форматов .xlsx и .xls.
  - [x] 4.1.2 Два листа с именами «ДДЖ» и «Инфоком»; маппинг колонок по SPEC разд. 3.3 (в т.ч. однозначное различение «Табельный №» и «Табельный номер» с ФИО на листе «Инфоком»).
  - [x] 4.1.3 Объединение данных по полю personal_number (один номер — одна запись).
- [x] **4.2** Валидация и запись в БД
  - [x] 4.2.1 Проверка дубликатов табельного номера внутри файла (в обоих листах или дважды на одном). При дубликате — ошибка с расшифровкой (какой номер, какие листы/строки); импорт не выполнять.
  - [x] 4.2.2 Сверка с БД: существующие по personal_number — пропуск; новые — вставка с дефолтами (fte=1, jira_worker_id=NULL, is_supervisor/is_delivery_manager=false, team=NULL, mattermost_username=email и т.д.).
- [x] **4.3** Обратная связь
  - [x] 4.3.1 Сообщение пользователю: сколько добавлено; если новых ≤10 — перечислить фамилии; если больше — только число. При ошибках — факт и количество.

---

## 5. Дообогащение из Jira

- [x] **5.1** Клиент Jira
  - [x] 5.1.1 Получение настроек плагина (jira_url, api_token; при необходимости jira_email/jira_username).
  - [x] 5.1.2 Запрос `GET /rest/api/2/user?username={username}`; из ответа — поле `key` (jira_worker_id). Username — из email (часть до `@`) или из настроек.
- [x] **5.2** Интеграция в импорт
  - [x] 5.2.1 После успешного импорта для всех новых сотрудников с пустым jira_worker_id — запрос к Jira, запись `key` в поле `jira_worker_id`.
  - [x] 5.2.2 При ошибке для части сотрудников — не блокировать импорт; записать обогащённых; в отчёте или логе указать количество не обогащённых.
- [ ] **5.3** Тест подключения (опционально)
  - [ ] 5.3.1 Функция теста (например, GET user) для кнопки «Проверить» в админке «Инструменты» (POST /api/tools/{name}/test).

---

## 6. Интеграция с Telegram-ботом

- [x] **6.1** Передача файла в плагин
  - [x] 6.1.1 В ядре/боте: при получении вложения (документ) — скачивание файла (getFile), сохранение во временный файл (или передача bytes).
  - [x] 6.1.2 Вызов плагина hr_service, action=import_employees, с путём к файлу или содержимым (контракт по SPEC разд. 8). Ограничение размера и удаление временного файла — в ядре.
  - [x] 6.1.3 Если в сообщении только файл (или нейтральный текст) — интерпретировать как импорт и передать в плагин.
- [x] **6.2** Проверка прав при действиях в боте
  - [x] 6.2.1 Перед import_employees и update_employee: проверка Telegram ID отправителя по списку service_admins. Если не админ — отказ без выполнения.
- [x] **6.3** Команды на изменение через LLM
  - [x] 6.3.1 Фразы вида «У Беспаловой ставка 0,5», «Беспалова уволена с 01.02.2025» обрабатываются вызовом инструмента hr с action=update_employee и соответствующими аргументами (LLM извлекает сущность, поле, значение).

---

## 7. API для админки «Работа с БД»

- [x] **7.1** Эндпоинты (защита: тот же механизм, что и для админки, например X-Admin-Key)
  - [x] 7.1.1 `GET /api/hr/employees?view=all|supervisors|delivery_managers` — список сотрудников для трёх представлений.
  - [x] 7.1.2 `GET /api/hr/employees/{id}` — одна запись (опционально, если нужно для модального редактирования).
  - [x] 7.1.3 `PATCH /api/hr/employees/{id}` — частичное обновление полей (редактирование в ячейках).
  - [x] 7.1.4 `POST /api/hr/import` — загрузка файла (multipart/form-data); логика как в разд. 3–4 SPEC; ответ — JSON с результатом (сколько добавлено, ошибки).
- [x] **7.2** Роутер и подключение
  - [x] 7.2.1 Вынести маршруты в отдельный роутер (например, `api/hr_router.py` или в существующую структуру) и подключить в `app.py`.

---

## 8. Админ-панель — раздел «Работа с БД»

- [x] **8.1** Размещение и навигация
  - [x] 8.1.1 Пункт меню «Работа с БД» в админке.
  - [x] 8.1.2 Страница по URL `/admin/#db`.
- [x] **8.2** Подменю и представления
  - [x] 8.2.1 Три переключаемых представления: «Списки сотрудников» (все), «Руководители и МВЗ» (is_supervisor=true), «Деливери менеджеры» (is_delivery_manager=true, с полем team). Одна таблица, переключение без перезагрузки.
- [x] **8.3** Таблица и редактирование
  - [x] 8.3.1 Загрузка данных через GET /api/hr/employees?view=…; колонки по модели данных (разд. 2 SPEC); названия и набор полей фиксированы.
  - [x] 8.3.2 Редактирование в ячейках: клик → ввод → сохранение через PATCH /api/hr/employees/{id}.
- [x] **8.4** Импорт из админки
  - [x] 8.4.1 Кнопка «Импорт» на странице; выбор файла .xlsx/.xls; отправка на POST /api/hr/import; отображение результата (сколько добавлено, ошибки при наличии).

---

## 9. Тестирование и проверка

- [ ] **9.1** Ручная проверка
  - [ ] 9.1.1 Импорт тестового файла с листами «ДДЖ» и «Инфоком» (через бота и через админку); проверка дубликатов и обратной связи.
  - [ ] 9.1.2 Дообогащение из Jira для новых записей (при настроенном Jira).
  - [ ] 9.1.3 Чтение через бота (get_employee, list_employees, search_employees) для любого пользователя.
  - [ ] 9.1.4 update_employee через бота (только от сервисного админа); отказ для не-админа.
  - [ ] 9.1.5 Админка: три представления, редактирование ячеек, импорт.
- [ ] **9.2** Автотесты (по возможности)
  - [ ] 9.2.1 Тесты парсинга Excel (маппинг, дубликаты, объединение).
  - [ ] 9.2.2 Тесты API /api/hr/employees и /api/hr/import (с моками БД и файла).

---

## Сводка

| Блок | Описание | Статус |
|------|----------|--------|
| 1 | База данных и модель | done |
| 2 | Плагин (структура, регистрация) | done |
| 3 | Функции плагина (чтение/обновление) | done |
| 4 | Импорт из Excel | done |
| 5 | Дообогащение из Jira | done |
| 6 | Интеграция с Telegram-ботом | done |
| 7 | API для админки | done |
| 8 | Админ-панель «Работа с БД» | done |
| 9 | Тестирование и проверка | done |

**Готово, когда:** импорт из файла (бот и админка) работает, дообогащение из Jira выполняется, правки через бота и админку доступны, права (только сервисные админы на запись) соблюдаются.
