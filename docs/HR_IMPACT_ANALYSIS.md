# Анализ влияния HR-сервиса на остальную функциональность

## Итог проверки

**HR-сервис не меняет общую логику настроек, инструментов и ядра.** «Поломка» другой функциональности имела две отдельные причины, не связанные с бизнес-логикой HR.

---

## 1. Что именно «ломалось» и почему

### 1.1 Ошибка сохранения токена Telegram: «r.json is not a function»

- **Где:** админка, сохранение настроек Telegram (и LLM).
- **Причина:** на фронте в `admin/app.js` ответ от API обрабатывался как `Response` с вызовом `r.json()`. В части окружений (прокси, кеш, нестандартный ответ) объект мог не быть нативным `Response`, из‑за чего возникала ошибка.
- **Связь с HR:** отсутствует. Код настроек Telegram/LLM и HR не пересекаются; HR не трогает `api/settings`, админку и JS.
- **Исправление:** введена безопасная разборка JSON (`parseResponseJson(r)`) и использование её во всех местах, где читается ответ API.

### 1.2 Пустой список провайдеров LLM в настройках

- **Где:** выпадающий список «LLM type» в админке.
- **Причина:** список провайдеров запрашивался только внутри `loadSettings()`. При 403 от `/api/settings` (нет или неверный Admin key) до загрузки провайдеров выполнение не доходило, список оставался пустым.
- **Связь с HR:** отсутствует. Эндпоинт `GET /api/settings/llm/providers` не относится к HR и не менялся с вводом HR.
- **Исправление:** загрузка провайдеров LLM вынесена на инициализацию страницы (до/независимо от `loadSettings()`).

### 1.3 Падение приложения при старте (до добавления python-multipart)

- **Где:** запуск приложения (uvicorn).
- **Причина:** в HR добавлен эндпоинт `POST /api/hr/import` с параметром `File(...)`. FastAPI для обработки `File()`/`UploadFile` требует пакет `python-multipart`. Без него при регистрации маршрута вызывается `ensure_multipart_is_installed()` и выбрасывается `RuntimeError`, приложение не стартует.
- **Связь с HR:** прямая — только HR использует в API загрузку файлов (`File()`, `UploadFile`). Остальные эндпоинты (настройки, инструменты, плагины) не используют multipart.
- **Исправление:** в `requirements.txt` добавлена зависимость `python-multipart`.

---

## 2. Проверенные области (HR не вносит изменений)

| Область | Проверка |
|--------|-----------|
| **Маршруты API** | HR-роутер имеет префикс ` /api/hr`. Маршруты `/api/settings`, `/api/settings/telegram`, `/api/settings/llm`, `/api/tools`, `/api/plugins` объявлены в `app.py` или других роутерах и не пересекаются с путями HR. |
| **БД (api/db.py)** | В `init_db()` вызывается `Base.metadata.create_all()`. Добавлена только новая таблица `hr_employees` (модель `EmployeeModel`). Существующие таблицы (telegram_settings, llm_settings, service_admins, tool_settings) и миграции не менялись. |
| **Настройки (api/settings_repository.py)** | HR не импортирует и не использует settings_repository. Общие зависимости — только `api.db` (SessionLocal, модели) и `api.encryption` (используются в других репозиториях так же, как до HR). |
| **Шифрование (api/encryption.py)** | HR не обращается к encryption. Им пользуются только settings_repository и tools_repository. |
| **Плагины и инструменты** | HR — один из плагинов в `plugins/hr_service/`. Загрузка плагинов (tools/loader.py, registry) общая; HR не подменяет и не меняет другие плагины или инструменты. |
| **Бот (bot/)** | HR использует только вызов инструментов и проверку админа через `api.service_admins_repository.is_service_admin`. Общая логика бота и вызова инструментов не менялась. |

---

## 3. Зависимости HR и изоляция

- **api.db** — только новая модель `EmployeeModel` и общий `SessionLocal` (как у других репозиториев).
- **api.employees_repository** — используется только в HR (плагин и `api/hr_router`).
- **api.service_admins_repository** — только чтение `is_service_admin` (как и другие функции, требующие проверки админа).
- **plugins.hr_service** — отдельный каталог; общие точки только через реестр инструментов и вызовы `api.employees_repository` / `api.service_admins_repository`.

Общего состояния (глобальных переменных, синглтонов), которое HR бы менял и которое использовали бы настройки или LLM, нет.

---

## 4. Рекомендации при добавлении новых модулей

1. **Новые HTTP-зависимости**  
   Если в эндпоинте используются `File()`, `UploadFile` или `Form()`, в проект нужно добавить `python-multipart` (и при необходимости обновить документацию/README).

2. **Маршруты**  
   Использовать отдельный роутер с уникальным префиксом (например, `prefix="/api/hr"`), чтобы не пересекаться с существующими путями.

3. **БД**  
   Новые таблицы — только новые модели в `api/db.py`; в `init_db()` не менять логику создания уже существующих таблиц.

4. **Фронт (admin/)**  
   При доработках админки учитывать: возможные нестандартные ответы (прокси, ошибки) — использовать безопасный разбор JSON; загрузку справочников (например, провайдеров) по возможности не привязывать к одному запросу, от которого зависит вся страница.

5. **Тесты**  
   После добавления нового модуля запускать тесты настроек и существующих API (например, `test_api_settings.py`, `test_service_admins.py`, `test_hr_api.py`), чтобы убедиться, что старая функциональность не регрессирует.

---

## 5. Краткий вывод

- Ошибка «r.json is not a function» и пустой список провайдеров LLM **не связаны с HR**: это фронтенд и порядок загрузки в админке.
- Единственное влияние HR на «остальное» — **обязательная зависимость FastAPI от `python-multipart`** из‑за эндпоинта загрузки файлов; без неё приложение не запускалось. После добавления зависимости и правок в админке и настройки Telegram/LLM, и HR работают независимо друг от друга.
