# ARCHITECTURE BLUEPRINT — LO_TG_BOT

> **Основной архитектурный документ для разработки**  
> Используется как референс при работе над каждым блоком/фазой

**Версия:** 1.1  
**Дата:** 2026-02-06  
**Подход:** Умный монолит с плагинами (один процесс)

---

## Связанные документы

| Документ | Описание | Статус |
|----------|----------|--------|
| [ARCHITECTURE_BLUEPRINT.md](ARCHITECTURE_BLUEPRINT.md) | Целевая архитектура (этот документ) | ✅ Актуален |
| [UPGRADE_TASKS.md](UPGRADE_TASKS.md) | Декомпозиция задач на 3-4 уровня | ✅ Актуален |
| [PLAN_PHASE_0_1.md](PLAN_PHASE_0_1.md) | Детальный план Фазы 0-1 | ✅ Актуален |
| [PLAN_PHASE_2.md](PLAN_PHASE_2.md) | Детальный план Фазы 2 (Plugin System) | 📋 Планируется |
| [PLAN_PHASE_3.md](PLAN_PHASE_3.md) | Детальный план Фазы 3 (Storage + API) | 📋 Планируется |
| [PLAN_PHASE_4.md](PLAN_PHASE_4.md) | Детальный план Фазы 4 (Админка Инструменты) | 📋 Планируется |
| [PLAN_PHASE_5.md](PLAN_PHASE_5.md) | Детальный план Фазы 5 (Админка Администраторы) | 📋 Планируется |
| [PLAN_PHASE_6.md](PLAN_PHASE_6.md) | Детальный план Фазы 6 (Worklog Checker) | 📋 Планируется |

### Существующая документация проекта

| Документ | Описание |
|----------|----------|
| [CURRENT_IMPLEMENTATION.md](CURRENT_IMPLEMENTATION.md) | Текущая реализация (до изменений) |
| [APP_DESCRIPTION_AND_API.md](APP_DESCRIPTION_AND_API.md) | Описание приложения и API |
| [LAUNCH_INSTRUCTIONS.md](LAUNCH_INSTRUCTIONS.md) | Инструкции по запуску |

---

## Как использовать этот документ

1. **При старте работы над блоком** — сверяйся с разделом "Блоки для независимой разработки"
2. **При создании плагина** — следуй стандарту из раздела "Структура плагина"
3. **При вопросах по flow** — смотри раздел "Flow обработки запроса"
4. **При оптимизации** — учитывай раздел "Ресурсы и ограничения"
5. **При планировании работ** — смотри [UPGRADE_TASKS.md](UPGRADE_TASKS.md)
6. **При реализации конкретной фазы** — смотри соответствующий PLAN_PHASE_X.md

---

## 1. Общая схема

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  │
│                        LO_TG_BOT (Один Python-процесс)                           │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                            │ │
│  │                    ВХОДНАЯ ТОЧКА (Telegram Bot)                            │ │
│  │                                                                            │ │
│  │   • Long polling (python-telegram-bot)                                     │ │
│  │   • Приём сообщений от пользователей                                       │ │
│  │   • Отправка ответов                                                       │ │
│  │   • Single instance (.bot.pid)                                             │ │
│  │   • Подпроцесс управляется через bot_runner                                │ │
│  │                                                                            │ │
│  │   [БЕЗ ИЗМЕНЕНИЙ — блок стабилен]                                          │ │
│  │                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                         │
│                                        ▼                                         │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                            │ │
│  │                      ОРКЕСТРАТОР (LLM Engine)                              │ │
│  │                                                                            │ │
│  │   ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │   │  Conversation Manager                                             │    │ │
│  │   │  • История диалогов (20 пар user/assistant)                       │    │ │
│  │   │  • Контекст по chat_id                                            │    │ │
│  │   │  [УЖЕ ЕСТЬ в telegram_bot.py]                                     │    │ │
│  │   └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                        │                                   │ │
│  │                                        ▼                                   │ │
│  │   ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │   │  LLM Router                                               [НОВОЕ] │    │ │
│  │   │                                                                   │    │ │
│  │   │  • Формирует запрос: system_prompt + tools + history + message   │    │ │
│  │   │  • System prompt на английском (экономия токенов)                │    │ │
│  │   │  • Tool descriptions из Registry                                  │    │ │
│  │   │  • Отправляет в LLM Provider                                      │    │ │
│  │   │  • Обрабатывает tool_calls                                        │    │ │
│  │   │  • Возвращает финальный ответ на русском                         │    │ │
│  │   └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                        │                                   │ │
│  │                                        ▼                                   │ │
│  │   ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │   │  LLM Provider Adapter                                             │    │ │
│  │   │                                                                   │    │ │
│  │   │  • OpenAI (GPT-4o-mini, GPT-4o)        ✅ tool-calling            │    │ │
│  │   │  • Anthropic (Claude)                  ✅ tool-calling            │    │ │
│  │   │  • Google (Gemini)                     ✅ tool-calling            │    │ │
│  │   │  • Groq, OpenRouter, Ollama            ⚠️ базовый tool-calling    │    │ │
│  │   │  • Azure, YandexGPT, etc.              ⚠️ зависит от модели       │    │ │
│  │   │                                                                   │    │ │
│  │   │  [РАСШИРЕНИЕ существующего bot/llm.py]                            │    │ │
│  │   └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                         │
│                          ┌─────────────┴─────────────┐                          │
│                          ▼                           ▼                          │
│  ┌─────────────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │                                 │  │                                     │  │
│  │     TOOL REGISTRY     [НОВОЕ]   │  │    TOOL EXECUTOR          [НОВОЕ]   │  │
│  │                                 │  │                                     │  │
│  │  • Список инструментов          │  │  • Маршрутизация вызова             │  │
│  │  • Описания (английский)        │  │  • Вызов handler из плагина         │  │
│  │  • Параметры (JSON Schema)      │  │  • Обработка ошибок                 │  │
│  │  • Статусы (enabled/disabled)   │  │  • Таймауты                         │  │
│  │  • Формирование tools для LLM   │  │  • Логирование вызовов              │  │
│  │                                 │  │                                     │  │
│  └─────────────────────────────────┘  └─────────────────────────────────────┘  │
│                 ▲                                      │                        │
│                 │                                      ▼                        │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                            │ │
│  │                         PLUGIN SYSTEM                            [НОВОЕ]   │ │
│  │                                                                            │ │
│  │   ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │   │  Plugin Loader                                                    │    │ │
│  │   │                                                                   │    │ │
│  │   │  • Сканирует папку plugins/                                       │    │ │
│  │   │  • Читает plugin.yaml (манифесты)                                 │    │ │
│  │   │  • Загружает handlers.py (код)                                    │    │ │
│  │   │  • Регистрирует tools в Registry                                  │    │ │
│  │   │  • Hot-reload плагинов (без перезапуска)                          │    │ │
│  │   └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                        │                                   │ │
│  │                                        ▼                                   │ │
│  │   ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │   │  Plugin Settings Manager                                          │    │ │
│  │   │                                                                   │    │ │
│  │   │  • Читает/пишет настройки плагинов из БД                         │    │ │
│  │   │  • Шифрование секретов (Fernet)                                   │    │ │
│  │   │  • Валидация по схеме из plugin.yaml                              │    │ │
│  │   └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                        │                                   │ │
│  │                                        ▼                                   │ │
│  │   ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │   │  Plugin LLM Client (опционально)                                  │    │ │
│  │   │                                                                   │    │ │
│  │   │  • Общий клиент для плагинов, которым нужен LLM                   │    │ │
│  │   │  • Может использовать главный LLM или отдельный                   │    │ │
│  │   │  • Специализированные промпты для каждого плагина                 │    │ │
│  │   └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                         │
│                                        ▼                                         │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                            │ │
│  │                              PLUGINS                                       │ │
│  │                                                                            │ │
│  │   plugins/                                                                 │ │
│  │   │                                                                        │ │
│  │   ├── builtin/                          [НОВОЕ — вместе с ядром]           │ │
│  │   │   ├── calculator/                                                      │ │
│  │   │   │   ├── plugin.yaml               # описание инструмента             │ │
│  │   │   │   └── handlers.py               # calculate()                      │ │
│  │   │   │                                                                    │ │
│  │   │   └── datetime_tools/                                                  │ │
│  │   │       ├── plugin.yaml                                                  │ │
│  │   │       └── handlers.py               # get_datetime(), get_weekday()    │ │
│  │   │                                                                        │ │
│  │   ├── worklog_checker/                  [ФАЗА 6 — первый бизнес-плагин]    │ │
│  │   │   ├── plugin.yaml                   # tools + settings (jira, tempo)   │ │
│  │   │   └── handlers.py                   # check_worklogs()                 │ │
│  │   │                                                                        │ │
│  │   ├── hr_service/                       [БУДУЩЕЕ]                          │ │
│  │   │   ├── plugin.yaml                                                      │ │
│  │   │   └── handlers.py                   # get_employee(), update_employee()│ │
│  │   │                                                                        │ │
│  │   ├── reminder/                         [БУДУЩЕЕ — использует LLM]         │ │
│  │   │   ├── plugin.yaml                   # uses_llm: true                   │ │
│  │   │   └── handlers.py                   # send_reminder() → генерация LLM  │ │
│  │   │                                                                        │ │
│  │   └── (другие плагины...)                                                  │ │
│  │                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                            │ │
│  │                            ADMIN API (FastAPI)                             │ │
│  │                                                                            │ │
│  │   Существующие эндпоинты [БЕЗ ИЗМЕНЕНИЙ]:                                  │ │
│  │   ├── /api/settings/telegram/*          # CRUD + test + activate          │ │
│  │   ├── /api/settings/llm/*               # CRUD + test + activate          │ │
│  │   └── /api/service-admins/*             # CRUD администраторов             │ │
│  │                                                                            │ │
│  │   Новые эндпоинты [НОВОЕ]:                                                 │ │
│  │   ├── /api/tools                        # GET список инструментов          │ │
│  │   ├── /api/tools/{name}                 # GET детали инструмента           │ │
│  │   ├── /api/tools/{name}/enable          # POST включить                    │ │
│  │   ├── /api/tools/{name}/disable         # POST выключить                   │ │
│  │   ├── /api/tools/{name}/settings        # GET/PUT настройки                │ │
│  │   ├── /api/tools/{name}/test            # POST проверить (если есть)       │ │
│  │   └── /api/plugins/reload               # POST перезагрузить плагины       │ │
│  │                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                            │ │
│  │                          ADMIN PANEL (Статика)                             │ │
│  │                                                                            │ │
│  │   Меню:                                                                    │ │
│  │   │                                                                        │ │
│  │   ├── Настройки                         [БЕЗ ИЗМЕНЕНИЙ]                    │ │
│  │   │   ├── Блок "Телеграм бот"                                              │ │
│  │   │   └── Блок "LLM"                                                       │ │
│  │   │                                                                        │ │
│  │   ├── Инструменты                       [НОВОЕ — Фаза 4]                   │ │
│  │   │   ├── Список инструментов                                              │ │
│  │   │   ├── Включение/выключение                                             │ │
│  │   │   ├── Настройки инструмента                                            │ │
│  │   │   └── Проверка подключения                                             │ │
│  │   │                                                                        │ │
│  │   └── Администраторы                    [НОВОЕ — Фаза 5]                   │ │
│  │       ├── Список админов                                                   │ │
│  │       ├── Добавление по Telegram ID                                        │ │
│  │       └── Удаление                                                         │ │
│  │                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                            │ │
│  │                              STORAGE (SQLite)                              │ │
│  │                                                                            │ │
│  │   Существующие таблицы [БЕЗ ИЗМЕНЕНИЙ]:                                    │ │
│  │   ├── telegram_settings                 # токен, base_url, статус         │ │
│  │   ├── llm_settings                      # провайдер, ключ, модель, промпт │ │
│  │   └── service_admins                    # telegram_id, данные профиля     │ │
│  │                                                                            │ │
│  │   Новые таблицы [НОВОЕ]:                                                   │ │
│  │   ├── tool_settings                     # настройки инструментов          │ │
│  │   │   ├── tool_name (PK)                                                   │ │
│  │   │   ├── enabled (bool)                                                   │ │
│  │   │   ├── settings_json (encrypted)     # JSON с настройками               │ │
│  │   │   └── updated_at                                                       │ │
│  │   │                                                                        │ │
│  │   └── tool_call_log                     # лог вызовов (опционально)        │ │
│  │       ├── id                                                               │ │
│  │       ├── tool_name                                                        │ │
│  │       ├── user_id                                                          │ │
│  │       ├── params_json                                                      │ │
│  │       ├── result_json                                                      │ │
│  │       ├── duration_ms                                                      │ │
│  │       └── created_at                                                       │ │
│  │                                                                            │ │
│  │   Шифрование: Fernet (как сейчас)                                          │ │
│  │                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  │
│                              ВНЕШНИЕ СИСТЕМЫ                                     │
│                                                                                  │
│   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌──────────────┐  │
│   │  Telegram API  │  │  LLM Providers │  │  Jira / Tempo  │  │  Mattermost  │  │
│   │                │  │                │  │                │  │  (будущее)   │  │
│   │  • getUpdates  │  │  • OpenAI      │  │  • REST API    │  │              │  │
│   │  • sendMessage │  │  • Anthropic   │  │  • Worklogs    │  │  • Webhook   │  │
│   │  • getMe       │  │  • Google      │  │  • Issues      │  │  • Messages  │  │
│   │                │  │  • Groq, etc.  │  │                │  │              │  │
│   └────────────────┘  └────────────────┘  └────────────────┘  └──────────────┘  │
│                                                                                  │
│   Все вызовы ИСХОДЯЩИЕ (приложение инициирует)                                  │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Блоки для независимой разработки

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  │
│                        КАРТА НЕЗАВИСИМЫХ БЛОКОВ                                  │
│                                                                                  │
│  ═══════════════════════════════════════════════════════════════════════════    │
│  ЯДРО (Core) — делается один раз, потом стабильно                               │
│  ═══════════════════════════════════════════════════════════════════════════    │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  БЛОК A: Tool-calling в LLM Engine                         [Фаза 1]     │   │
│   │                                                                         │   │
│   │  Файлы:                                                                 │   │
│   │  • bot/llm.py                    — расширение get_reply()              │   │
│   │  • bot/tool_calling.py           — новый, логика tool-calling          │   │
│   │                                                                         │   │
│   │  Зависимости: Нет (самодостаточный)                                    │   │
│   │  Тесты: tests/test_tool_calling.py                                     │   │
│   │                                                                         │   │
│   │  Критерий готовности:                                                   │   │
│   │  • LLM вызывает захардкоженные tools                                   │   │
│   │  • Обычный чат работает как раньше                                     │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│                                        ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  БЛОК B: Tool Registry + Plugin Loader                     [Фаза 2]     │   │
│   │                                                                         │   │
│   │  Файлы:                                                                 │   │
│   │  • tools/__init__.py                                                    │   │
│   │  • tools/registry.py             — реестр инструментов                 │   │
│   │  • tools/loader.py               — загрузчик плагинов                  │   │
│   │  • tools/base.py                 — базовые функции для плагинов        │   │
│   │                                                                         │   │
│   │  Зависимости: Блок A                                                   │   │
│   │  Тесты: tests/test_tools_registry.py                                   │   │
│   │                                                                         │   │
│   │  Критерий готовности:                                                   │   │
│   │  • Инструменты загружаются из YAML                                     │   │
│   │  • Registry формирует tools для LLM                                    │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│                                        ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  БЛОК C: Настройки инструментов в БД                       [Фаза 3]     │   │
│   │                                                                         │   │
│   │  Файлы:                                                                 │   │
│   │  • api/db.py                     — добавить ToolSettingsModel          │   │
│   │  • api/tools_repository.py       — CRUD настроек                       │   │
│   │  • api/tools_router.py           — API эндпоинты                       │   │
│   │  • api/app.py                    — подключить роутер                   │   │
│   │                                                                         │   │
│   │  Зависимости: Блок B                                                   │   │
│   │  Тесты: tests/test_tools_api.py                                        │   │
│   │                                                                         │   │
│   │  Критерий готовности:                                                   │   │
│   │  • API для управления инструментами                                    │   │
│   │  • Настройки шифруются как TG/LLM                                      │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│                                        ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  БЛОК D: Builtin-плагины (calculator, datetime)            [Фаза 2]     │   │
│   │                                                                         │   │
│   │  Файлы:                                                                 │   │
│   │  • plugins/builtin/calculator/plugin.yaml                               │   │
│   │  • plugins/builtin/calculator/handlers.py                               │   │
│   │  • plugins/builtin/datetime_tools/plugin.yaml                           │   │
│   │  • plugins/builtin/datetime_tools/handlers.py                           │   │
│   │                                                                         │   │
│   │  Зависимости: Блок B                                                   │   │
│   │  Тесты: tests/test_builtin_plugins.py                                  │   │
│   │                                                                         │   │
│   │  Критерий готовности:                                                   │   │
│   │  • "Сколько времени?" → ответ через tool                               │   │
│   │  • "Посчитай 2+2*3" → ответ через tool                                 │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ═══════════════════════════════════════════════════════════════════════════    │
│  АДМИНКА — независимые UI-блоки                                                 │
│  ═══════════════════════════════════════════════════════════════════════════    │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  БЛОК E: Админка "Инструменты"                             [Фаза 4]     │   │
│   │                                                                         │   │
│   │  Файлы:                                                                 │   │
│   │  • admin/index.html              — новый пункт меню                    │   │
│   │  • admin/tools.js                — логика страницы инструментов        │   │
│   │  • admin/styles.css              — стили                               │   │
│   │                                                                         │   │
│   │  Зависимости: Блок C (API готов)                                       │   │
│   │  Тесты: ручное тестирование UI                                         │   │
│   │                                                                         │   │
│   │  Критерий готовности:                                                   │   │
│   │  • Список инструментов в UI                                            │   │
│   │  • Включение/выключение                                                │   │
│   │  • Форма настроек                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  БЛОК F: Админка "Администраторы"                          [Фаза 5]     │   │
│   │                                                                         │   │
│   │  Файлы:                                                                 │   │
│   │  • admin/index.html              — новый пункт меню                    │   │
│   │  • admin/admins.js               — логика страницы админов             │   │
│   │                                                                         │   │
│   │  Зависимости: Нет (API уже есть!)                                      │   │
│   │  Тесты: ручное тестирование UI                                         │   │
│   │                                                                         │   │
│   │  Критерий готовности:                                                   │   │
│   │  • Список админов в UI                                                 │   │
│   │  • Добавление/удаление                                                 │   │
│   │                                                                         │   │
│   │  ПРИМЕЧАНИЕ: Можно делать параллельно с другими фазами!                │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ═══════════════════════════════════════════════════════════════════════════    │
│  ПЛАГИНЫ — каждый разрабатывается независимо                                    │
│  ═══════════════════════════════════════════════════════════════════════════    │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  ПЛАГИН: Worklog Checker                                   [Фаза 6]     │   │
│   │                                                                         │   │
│   │  Файлы:                                                                 │   │
│   │  • plugins/worklog_checker/plugin.yaml                                  │   │
│   │  • plugins/worklog_checker/handlers.py                                  │   │
│   │  • plugins/worklog_checker/jira_client.py  (опционально)                │   │
│   │  • plugins/worklog_checker/tempo_client.py (опционально)                │   │
│   │                                                                         │   │
│   │  Зависимости: Ядро готово (Блоки A-D)                                  │   │
│   │  Внешние API: Jira REST API, Tempo API                                 │   │
│   │  Настройки: jira_url, jira_token, tempo_token                          │   │
│   │                                                                         │   │
│   │  Критерий готовности:                                                   │   │
│   │  • "Проверь ворклоги Иванова" → реальные данные из Jira                │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  ПЛАГИН: HR Service                                        [Будущее]    │   │
│   │                                                                         │   │
│   │  Файлы:                                                                 │   │
│   │  • plugins/hr_service/plugin.yaml                                       │   │
│   │  • plugins/hr_service/handlers.py                                       │   │
│   │                                                                         │   │
│   │  Инструменты:                                                           │   │
│   │  • get_employee — получить данные сотрудника                           │   │
│   │  • list_employees — список сотрудников                                 │   │
│   │  • update_employee — обновить данные                                   │   │
│   │  • import_employees — импорт из Excel/CSV                              │   │
│   │                                                                         │   │
│   │  Зависимости: Ядро                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  ПЛАГИН: Reminder (с LLM)                                  [Будущее]    │   │
│   │                                                                         │   │
│   │  Файлы:                                                                 │   │
│   │  • plugins/reminder/plugin.yaml        # uses_llm: true                 │   │
│   │  • plugins/reminder/handlers.py                                         │   │
│   │  • plugins/reminder/templates.py       # промпты для генерации          │   │
│   │                                                                         │   │
│   │  Инструменты:                                                           │   │
│   │  • find_violators — найти нарушителей                                  │   │
│   │  • send_reminder — сгенерировать и отправить напоминание               │   │
│   │  • escalate — эскалация на руководителя                                │   │
│   │                                                                         │   │
│   │  Особенность: Использует LLM для генерации текста                      │   │
│   │  Зависимости: Ядро + worklog_checker + hr_service                      │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  ПЛАГИН: Calculator (пример внешнего API)                  [Будущее]    │   │
│   │                                                                         │   │
│   │  plugin.yaml:                                                           │   │
│   │    type: external                      # внешний HTTP endpoint          │   │
│   │    endpoint: http://calc-service:8001                                   │   │
│   │                                                                         │   │
│   │  Это показывает как подключить внешний сервис                          │   │
│   │  (когда переедете в корп. контур и понадобится масштабирование)        │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Порядок разработки и зависимости

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  │
│                         ГРАФ ЗАВИСИМОСТЕЙ                                        │
│                                                                                  │
│                                                                                  │
│   ┌─────────────┐                                                                │
│   │   Фаза 0    │  Стабилизация, тесты, ветка                                   │
│   │  (1-2 дня)  │                                                                │
│   └──────┬──────┘                                                                │
│          │                                                                       │
│          ▼                                                                       │
│   ┌─────────────┐                                                                │
│   │   Фаза 1    │  Tool-calling в LLM (Блок A)                                  │
│   │  (3-5 дней) │  • Захардкоженные tools                                       │
│   └──────┬──────┘  • get_reply() с tool-calling                                 │
│          │                                                                       │
│          ▼                                                                       │
│   ┌─────────────┐                                                                │
│   │   Фаза 2    │  Registry + Loader + Builtin (Блоки B, D)                     │
│   │  (3-5 дней) │  • Загрузка из YAML                                           │
│   └──────┬──────┘  • calculator, datetime                                       │
│          │                                                                       │
│          ▼                                                                       │
│   ┌─────────────┐                                                                │
│   │   Фаза 3    │  Настройки в БД + API (Блок C)                                │
│   │  (3-5 дней) │  • ToolSettingsModel                                          │
│   └──────┬──────┘  • /api/tools/* эндпоинты                                     │
│          │                                                                       │
│          ├─────────────────────────────────┐                                    │
│          │                                 │                                    │
│          ▼                                 ▼                                    │
│   ┌─────────────┐                   ┌─────────────┐                             │
│   │   Фаза 4    │                   │   Фаза 5    │  ← можно параллельно!       │
│   │  (1 неделя) │                   │  (3-5 дней) │                             │
│   │             │                   │             │                             │
│   │ Админка     │                   │ Админка     │                             │
│   │ Инструменты │                   │ Админы      │                             │
│   │ (Блок E)    │                   │ (Блок F)    │                             │
│   └──────┬──────┘                   └─────────────┘                             │
│          │                                                                       │
│          ▼                                                                       │
│   ┌─────────────┐                                                                │
│   │   Фаза 6    │  Первый бизнес-плагин: Worklog Checker                        │
│   │ (1-2 недели)│  • Интеграция Jira/Tempo                                      │
│   └──────┬──────┘  • E2E тест                                                   │
│          │                                                                       │
│          ▼                                                                       │
│   ┌─────────────┐                                                                │
│   │  Фаза 7+    │  Новые плагины по мере необходимости                          │
│   │             │  • HR Service                                                 │
│   │             │  • Reminder (с LLM)                                           │
│   │             │  • ...                                                        │
│   └─────────────┘                                                                │
│                                                                                  │
│                                                                                  │
│   ПРИМЕЧАНИЕ: Фаза 5 (Админка Администраторы) может выполняться                 │
│   параллельно с Фазами 4 и 6, так как API уже существует.                       │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Структура плагина (стандарт)

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  │
│                    АНАТОМИЯ ПЛАГИНА                                              │
│                                                                                  │
│   plugins/                                                                       │
│   └── {plugin_name}/                                                             │
│       │                                                                          │
│       ├── plugin.yaml              # Манифест (обязательно)                      │
│       │   │                                                                      │
│       │   ├── id: string           # Уникальный идентификатор                   │
│       │   ├── name: string         # Название для UI                            │
│       │   ├── version: string      # Версия плагина                             │
│       │   ├── description: string  # Описание для UI                            │
│       │   ├── enabled: bool        # Включён по умолчанию                       │
│       │   │                                                                      │
│       │   ├── tools:               # Список инструментов                        │
│       │   │   └── - name: string                                                │
│       │   │       description: string (ENGLISH!)                                │
│       │   │       handler: string  # Путь к функции                             │
│       │   │       parameters:      # JSON Schema                                │
│       │   │       uses_llm: bool   # Использует LLM (опционально)               │
│       │   │       timeout: int     # Таймаут в секундах                         │
│       │   │                                                                      │
│       │   └── settings:            # Настройки плагина (опционально)            │
│       │       └── - key: string                                                 │
│       │           label: string                                                 │
│       │           type: string|password|number|select|bool                      │
│       │           required: bool                                                │
│       │           default: any                                                  │
│       │           options: []      # Для select                                 │
│       │                                                                          │
│       ├── handlers.py              # Код инструментов (обязательно)             │
│       │   │                                                                      │
│       │   ├── async def tool_name(param1, param2) -> str | dict                 │
│       │   │   """Docstring — описание для логов"""                              │
│       │   │   ...                                                               │
│       │   │   return result                                                     │
│       │   │                                                                      │
│       │   └── # Может использовать:                                             │
│       │       # from tools.base import get_setting, get_llm_client              │
│       │                                                                          │
│       └── (дополнительные файлы)   # По необходимости                           │
│           ├── client.py            # Клиенты для внешних API                    │
│           ├── models.py            # Pydantic модели                            │
│           └── templates.py         # Промпты для LLM                            │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Пример plugin.yaml (Worklog Checker)

```yaml
# plugins/worklog_checker/plugin.yaml

id: worklog-checker
name: "Проверка ворклогов"
version: "1.0.0"
description: "Проверяет списание времени сотрудников в Jira/Tempo"
enabled: false  # Требует настройки перед включением

tools:
  - name: check_worklogs
    description: "Checks employee worklogs in Jira/Tempo for a specified period. Returns logged hours, required hours, and deficit."
    handler: check_worklogs
    timeout: 60
    parameters:
      type: object
      properties:
        employee:
          type: string
          description: "Employee name, email, or Jira username"
        period:
          type: string
          description: "Period to check: today, yesterday, week, month, or date range (YYYY-MM-DD:YYYY-MM-DD)"
          default: "week"
      required:
        - employee

  - name: get_worklog_summary
    description: "Gets worklog summary for a team or department"
    handler: get_worklog_summary
    timeout: 120
    parameters:
      type: object
      properties:
        team:
          type: string
          description: "Team or department name"
        period:
          type: string
          default: "week"
      required:
        - team

settings:
  - key: jira_url
    label: "Jira URL"
    type: string
    required: true
    description: "https://your-company.atlassian.net"
  
  - key: jira_email
    label: "Jira Email"
    type: string
    required: true
  
  - key: jira_token
    label: "Jira API Token"
    type: password
    required: true
  
  - key: tempo_token
    label: "Tempo API Token"
    type: password
    required: true
  
  - key: required_hours_per_day
    label: "Норма часов в день"
    type: number
    default: 8
  
  - key: working_days
    label: "Рабочие дни"
    type: string
    default: "mon,tue,wed,thu,fri"
```

---

## 6. Flow обработки запроса (целевой)

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  │
│  ПОЛЬЗОВАТЕЛЬ: "Проверь ворклоги Иванова за эту неделю"                         │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│  1. TELEGRAM BOT                                                                 │
│                                                                                  │
│     • Получает сообщение через long polling                                      │
│     • Извлекает chat_id, user_id, text                                           │
│     • Передаёт в Conversation Manager                                            │
└──────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│  2. CONVERSATION MANAGER                                                         │
│                                                                                  │
│     • Достаёт историю диалога для chat_id                                        │
│     • Формирует messages: [system, ...history, user_message]                     │
│     • System prompt: АНГЛИЙСКИЙ                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│  3. LLM ROUTER                                                                   │
│                                                                                  │
│     • Получает tools из Registry (enabled только)                               │
│     • Tool descriptions: АНГЛИЙСКИЙ                                              │
│     • Отправляет запрос в LLM Provider                                           │
│                                                                                  │
│     Request:                                                                     │
│     {                                                                            │
│       "model": "gpt-4o-mini",                                                    │
│       "messages": [...],                                                         │
│       "tools": [                                                                 │
│         {                                                                        │
│           "type": "function",                                                    │
│           "function": {                                                          │
│             "name": "check_worklogs",                                            │
│             "description": "Checks employee worklogs...",                        │
│             "parameters": {...}                                                  │
│           }                                                                      │
│         }                                                                        │
│       ]                                                                          │
│     }                                                                            │
└──────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│  4. LLM PROVIDER (OpenAI / Anthropic / etc.)                                     │
│                                                                                  │
│     Response:                                                                    │
│     {                                                                            │
│       "tool_calls": [                                                            │
│         {                                                                        │
│           "id": "call_123",                                                      │
│           "function": {                                                          │
│             "name": "check_worklogs",                                            │
│             "arguments": "{\"employee\": \"Иванов\", \"period\": \"week\"}"      │
│           }                                                                      │
│         }                                                                        │
│       ]                                                                          │
│     }                                                                            │
└──────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│  5. TOOL EXECUTOR                                                                │
│                                                                                  │
│     • Находит handler в Registry                                                 │
│     • Вызывает: check_worklogs(employee="Иванов", period="week")                 │
│     • Логирует вызов                                                             │
│     • Обрабатывает таймаут/ошибки                                                │
└──────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│  6. PLUGIN: worklog_checker                                                      │
│                                                                                  │
│     async def check_worklogs(employee, period):                                  │
│         settings = get_settings("worklog-checker")                               │
│         jira = JiraClient(settings.jira_url, settings.jira_token)                │
│         tempo = TempoClient(settings.tempo_token)                                │
│                                                                                  │
│         worklogs = await tempo.get_worklogs(employee, period)                    │
│         return {                                                                 │
│             "employee": "Иванов Пётр",                                           │
│             "period": "2024-01-08 — 2024-01-12",                                 │
│             "logged_hours": 32,                                                  │
│             "required_hours": 40,                                                │
│             "deficit": 8,                                                        │
│             "tasks_without_logs": ["PROJ-123", "PROJ-456"]                       │
│         }                                                                        │
└──────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│  7. LLM ROUTER (продолжение)                                                     │
│                                                                                  │
│     • Добавляет tool_result в messages                                           │
│     • Отправляет повторный запрос в LLM                                          │
│     • LLM формулирует ответ НА РУССКОМ                                           │
└──────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│  8. TELEGRAM BOT                                                                 │
│                                                                                  │
│     • Отправляет ответ пользователю                                              │
│     • Сохраняет в историю                                                        │
│                                                                                  │
│     "Иванов Пётр за эту неделю (08.01 — 12.01):                                  │
│      • Списано: 32 часа                                                          │
│      • Норма: 40 часов                                                           │
│      • Недостача: 8 часов                                                        │
│                                                                                  │
│      Задачи без списаний: PROJ-123, PROJ-456"                                    │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Ресурсы и ограничения

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  │
│                    РЕСУРСЫ (Mac Mini)                                            │
│                                                                                  │
│   Что используем:                                                                │
│   ├── 1 Python-процесс (uvicorn + бот-подпроцесс)                               │
│   ├── SQLite (файл ~1-10 MB)                                                    │
│   ├── RAM: ~100-300 MB                                                          │
│   └── CPU: минимальная нагрузка (long polling, периодические запросы)           │
│                                                                                  │
│   Что НЕ используем:                                                             │
│   ├── ❌ PostgreSQL                                                              │
│   ├── ❌ Redis                                                                   │
│   ├── ❌ Message Broker                                                          │
│   ├── ❌ Отдельные контейнеры для каждого сервиса                               │
│   └── ❌ Kubernetes                                                              │
│                                                                                  │
│   Оптимизация токенов:                                                           │
│   ├── System prompt: английский                                                  │
│   ├── Tool descriptions: английский                                              │
│   ├── Короткие описания                                                          │
│   ├── Модель: GPT-4o-mini или Gemini Flash                                      │
│   └── Экономия: ~20-25%                                                          │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Путь масштабирования (на будущее)

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  │
│   Mac Mini (сейчас)                      Корп. контур (потом)                   │
│   ─────────────────                      ───────────────────                    │
│                                                                                  │
│   Один процесс          ───────────►     Можно так же оставить                  │
│                                          ИЛИ                                    │
│                                          Тяжёлые плагины → отдельные сервисы   │
│                                                                                  │
│   SQLite                ───────────►     PostgreSQL (если нужно)                │
│                                                                                  │
│   Плагины как модули    ───────────►     type: external в plugin.yaml          │
│                                          (HTTP endpoint вместо локального)      │
│                                                                                  │
│   ─────────────────────────────────────────────────────────────────────────────  │
│                                                                                  │
│   Пример миграции плагина:                                                       │
│                                                                                  │
│   # Было (локальный)                    # Стало (внешний)                       │
│   type: local                           type: external                          │
│   handler: check_worklogs               endpoint: http://worklog-svc:8001       │
│                                         path: /api/check                        │
│                                                                                  │
│   Код ядра не меняется!                                                         │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Итоговая сводка

| Компонент | Статус | Фаза |
|-----------|--------|------|
| Telegram Bot | Без изменений | — |
| LLM Provider Adapter | Без изменений | — |
| Admin API (TG, LLM, Admins) | Без изменений | — |
| Админка (Настройки) | Без изменений | — |
| **Tool-calling в LLM** | **НОВОЕ** | 1 |
| **Tool Registry** | **НОВОЕ** | 2 |
| **Plugin Loader** | **НОВОЕ** | 2 |
| **Builtin плагины** | **НОВОЕ** | 2 |
| **Tool Settings в БД** | **НОВОЕ** | 3 |
| **Tools API** | **НОВОЕ** | 3 |
| **Админка (Инструменты)** | **НОВОЕ** | 4 |
| **Админка (Администраторы)** | **НОВОЕ** | 5 |
| **Worklog Checker плагин** | **НОВОЕ** | 6 |

**Общее время:** 6-8 недель до полностью рабочей системы с первым бизнес-плагином.

---

## Версионирование

| Версия | Дата | Описание |
|--------|------|----------|
| 1.0 | 2026-02-06 | Первая версия целевой архитектуры |
